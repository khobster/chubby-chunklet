<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<title>Chubby Chunklet</title>
<style>
:root{
  --bg:#f2f2f2; --wood:#8b4d20; --wood-dark:#5b2c0d;
  --accent:#ffc931; --btn:#2c3e50; --danger:#e95800;
}
*{box-sizing:border-box;font-family:"Inter",system-ui,sans-serif;}
body{
  margin:0; background:var(--bg); min-height:100vh;
  display:flex; justify-content:center; align-items:center; padding:32px;
  overflow:hidden;
}
.wrapper{text-align:center;max-width:560px;width:100%;}
h1{margin:0 0 10px;font-size:32px;font-weight:700;letter-spacing:.5px;}
.subtitle{margin:0 0 26px;color:#555;font-size:14px;line-height:1.4;}

.stage{position:relative;width:320px;height:300px;margin:0 auto;}
.box{
  position:absolute;bottom:0;left:50%;transform:translateX(-50%);
  width:240px;height:170px;background:var(--wood);
  border:6px solid var(--wood-dark);border-radius:14px;
  box-shadow:0 14px 26px rgba(0,0,0,.18);
  display:flex;justify-content:center;align-items:flex-end;
}
.box.shake{animation:shake .6s infinite;}
@keyframes shake{
  0%,100%{transform:translate(-50%,0) rotate(0deg);}
  20%{transform:translate(calc(-50% - 3px),1px) rotate(-2deg);}
  40%{transform:translate(calc(-50% + 3px),-1px) rotate(2deg);}
  60%{transform:translate(calc(-50% - 2px),1px) rotate(-1.4deg);}
  80%{transform:translate(calc(-50% + 2px),0) rotate(1.2deg);}
}
.lid{
  position:absolute;top:-70px;left:0;width:100%;height:70px;
  background:var(--wood);border:6px solid var(--wood-dark);border-bottom:none;
  border-radius:14px 14px 0 0;transform-origin:bottom center;
  transition:transform 480ms cubic-bezier(.25,.8,.3,1.4);
  box-shadow:0 6px 18px -4px rgba(0,0,0,.35);
}
.popped .lid{transform:rotateX(78deg);}
.spring-wrapper{
  position:absolute;bottom:8px;left:50%;transform:translate(-50%,0) scaleY(.08);
  transform-origin:bottom center;transition:transform 360ms cubic-bezier(.25,.8,.3,1.4);
}
.popped .spring-wrapper{transform:translate(-50%,0) scaleY(1);}
.spring{
  width:30px;height:160px;
  background:repeating-linear-gradient(#333 0 6px,#ddd 6px 12px);
  border-radius:10px;margin:0 auto;position:relative;
}
.character{
  position:absolute;bottom:150px;left:50%;transform:translate(-50%,0);
  width:110px;height:110px;background:var(--accent);
  border:6px solid #e7b418;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 8px 20px rgba(0,0,0,.25);
}
.face{position:relative;width:70px;height:70px;}
.eye{width:14px;height:14px;background:#111;border-radius:50%;position:absolute;top:18px;}
.eye.left{left:10px;} .eye.right{right:10px;}
.mouth{
  width:22px;height:22px;background:#111;border-radius:50%;
  position:absolute;left:50%;bottom:10px;transform:translateX(-50%) scaleY(.35);
  transition:transform 70ms;
}
.mouth.open{transform:translateX(-50%) scaleY(1);}
.bob{animation:bob 2.4s ease-in-out infinite;}
@keyframes bob{
  0%,100%{transform:translate(-50%,0);}
  50%{transform:translate(-50%,6px);}
}
#pullBtn{
  margin:26px auto 14px;display:inline-block;background:var(--btn);color:#fff;
  border:none;font-size:20px;font-weight:600;padding:22px 50px;border-radius:60px;
  cursor:pointer;letter-spacing:.4px;
  box-shadow:10px 10px 24px rgba(0,0,0,.28),-10px -10px 24px rgba(255,255,255,.7);
  transition:transform .2s, box-shadow .2s;
}
#pullBtn:hover{
  transform:translateY(-4px);
  box-shadow:14px 14px 30px rgba(0,0,0,.32),-14px -14px 30px rgba(255,255,255,.72);
}
#pullBtn:active{
  transform:scale(.93);
  box-shadow:inset 8px 8px 16px rgba(0,0,0,.3),inset -8px -8px 16px rgba(255,255,255,.85);
}
.caption{
  min-height:54px;font-size:18px;line-height:1.3;color:#222;font-weight:500;
  padding:14px 22px;background:#fff;border:1px solid #ddd;border-radius:18px;
  width:480px;max-width:95%;margin:8px auto 0;
  opacity:0;transform:translateY(6px);transition:opacity .4s,transform .4s;
  box-shadow:0 0 0 transparent;
}
.caption.show{opacity:1;transform:translateY(0);}
small.note{display:block;margin-top:14px;color:#666;font-size:12px;}
.error{color:var(--danger);font-size:14px;margin-top:8px;}
@keyframes ring{
  0%{transform:translate(-50%,-50%) scale(.3);opacity:.85;}
  100%{transform:translate(-50%,-50%) scale(3.2);opacity:0;}
}
body::before{
  content:'';position:fixed;top:50%;left:50%;width:340px;height:340px;
  border-radius:50%;pointer-events:none;opacity:0;z-index:-1;
}
body.burst::before{
  background:radial-gradient(circle,var(--accent) 0%,rgba(255,201,49,0) 70%);
  animation:ring .9s ease-out;
}
@keyframes confetti{
  0%{transform:translateY(0) rotate(0deg);opacity:1;}
  100%{transform:translateY(620px) rotate(760deg);opacity:0;}
}
.confetti{
  position:fixed;top:-40px;width:12px;height:16px;border-radius:2px;
  background:var(--c);pointer-events:none;z-index:999;animation:confetti 1.4s ease-out forwards;
}
@media (max-height:660px){
  body{align-items:flex-start;padding-top:40px;}
  .stage{transform:scale(.9);}
}
</style>
</head>
<body>
  <div class="wrapper">
    <h1>Chubby Chunklet</h1>
    <p class="subtitle">Knock the string. Neighbor pops out with an absurd doorâ€‘answer every time.</p>

    <div class="stage">
      <div id="box" class="box">
        <div class="lid"></div>
        <div class="spring-wrapper">
          <div class="spring"></div>
          <div class="character">
            <div class="face">
              <div class="eye left"></div>
              <div class="eye right"></div>
              <div class="mouth" id="mouth"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <button id="pullBtn">KNOCK / PULL STRING</button>
    <div id="caption" class="caption"></div>
    <div id="err" class="error" style="display:none;"></div>
    <small class="note">Safe whimsical output. Prefetch keeps it snappy.</small>
  </div>

<script>
const ENDPOINT = 'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet'; // change
const PREFETCH_MIN_DELAY_MS = 450;

let prefetched = null;
let busy = false;
const box = document.getElementById('box');
const pullBtn = document.getElementById('pullBtn');
const caption = document.getElementById('caption');
const errEl = document.getElementById('err');
const mouth = document.getElementById('mouth');

function burst(){
  document.body.classList.add('burst');
  setTimeout(()=>document.body.classList.remove('burst'),900);
  const colors=['#ffc931','#ff9f3d','#ffd447','#ffb347','#ffe28f'];
  for(let i=0;i<28;i++){
    const el=document.createElement('span');
    el.className='confetti';
    el.style.setProperty('--c',colors[Math.random()*colors.length|0]);
    el.style.left=(Math.random()*100)+'vw';
    el.style.transform=`scale(${0.7+Math.random()*0.9})`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),1400);
  }
}

async function getLine(){
  const r = await fetch(ENDPOINT + '?t=' + Date.now());
  if(!r.ok) throw new Error('server '+r.status);
  return r.json();
}

async function ensurePrefetch(){
  if(!prefetched){
    try{ prefetched = await getLine(); }
    catch(e){ console.warn('prefetch fail', e); }
  }
}

function playBase64Audio(b64, mime, onStart, onEnd){
  const audio = new Audio(`data:${mime};base64,${b64}`);
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const src = ctx.createMediaElementSource(audio);
  const analyser = ctx.createAnalyser();
  analyser.fftSize = 256;
  src.connect(analyser); analyser.connect(ctx.destination);
  const data = new Uint8Array(analyser.frequencyBinCount);

  function loop(){
    if(audio.paused || audio.ended){ mouth.classList.remove('open'); return; }
    analyser.getByteFrequencyData(data);
    const avg = data.reduce((a,b)=>a+b,0)/data.length;
    if(avg > 40) mouth.classList.add('open'); else mouth.classList.remove('open');
    requestAnimationFrame(loop);
  }

  audio.addEventListener('play', ()=>{ onStart&&onStart(); requestAnimationFrame(loop); });
  audio.addEventListener('ended', ()=>{ mouth.classList.remove('open'); onEnd&&onEnd(); });
  audio.play().catch(err=>{ console.warn(err); onEnd&&onEnd(); });
}

pullBtn.addEventListener('click', async ()=>{
  if(busy) return;
  busy = true; errEl.style.display='none';
  caption.classList.remove('show'); caption.textContent='';
  box.classList.add('shake');

  const start = performance.now();
  let packet = prefetched;
  if(!packet){
    try { packet = await getLine(); }
    catch(e){
      packet = { text:"Chunklet sneezes in Morse code... try again!", audioBase64:null, mime:"audio/mpeg" };
      errEl.textContent = "Temporary hiccup.";
      errEl.style.display='block';
    }
  }
  prefetched = null;

  const elapsed = performance.now()-start;
  if(elapsed < PREFETCH_MIN_DELAY_MS){
    await new Promise(r=>setTimeout(r, PREFETCH_MIN_DELAY_MS - elapsed));
  }

  box.classList.remove('shake');
  box.classList.add('popped');
  burst();
  caption.textContent = packet.text;
  caption.classList.add('show');
  box.querySelector('.spring-wrapper').classList.add('bob');

  const settle = ()=>{
    box.querySelector('.spring-wrapper').classList.remove('bob');
    box.classList.remove('popped');
    busy = false;
    ensurePrefetch();
  };

  if(packet.audioBase64){
    playBase64Audio(packet.audioBase64, packet.mime || 'audio/mpeg', ()=>{}, ()=>settle());
  } else {
    setTimeout(()=>settle(), 2300);
  }

  ensurePrefetch();
});

ensurePrefetch();
</script>
</body>
</html>
