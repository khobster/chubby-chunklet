<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chubby Chunklet</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --box:#8248ff;
    --lid:#6d33e6;
    --spring:#555;
    --bg:#f6f6fb;
    --accent:#ffcc33;
    --char:#ffe14d;
    --char-outline:#222;
  }
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Inter,sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:32px;
    min-height:100vh;
    background:radial-gradient(circle at 50% 30%,#ffffff 0%,#ecebfa 70%);
    color:#222;
  }
  h1{
    font-size:clamp(1.8rem,4vw,3rem);
    margin:0 0 0.25em;
    letter-spacing:.5px;
    background:linear-gradient(90deg,#8248ff,#ff9c3d);
    -webkit-background-clip:text;
    color:transparent;
  }
  .sub{
    margin-top:-18px;
    font-size:.9rem;
    opacity:.65;
  }
  .stage{
    position:relative;
    width:240px;
    height:300px;
    perspective:900px;
  }

  /* Box base */
  .box{
    position:absolute;
    bottom:0;
    left:50%;
    transform:translateX(-50%);
    width:180px;
    height:160px;
    background:linear-gradient(135deg,var(--box) 0%,#5b23c5 100%);
    border-radius:14px;
    box-shadow:0 12px 28px -6px rgba(60,35,120,.45),0 4px 8px rgba(0,0,0,.2);
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:visible;
  }
  .box::before{
    content:"";
    position:absolute;
    inset:0;
    border:3px solid rgba(255,255,255,.15);
    border-radius:14px;
    pointer-events:none;
  }

  /* Lid */
  .lid{
    position:absolute;
    width:180px;
    height:30px;
    left:50%;
    bottom:160px;
    transform:translate(-50%,0) rotateX(0deg);
    transform-origin:50% 100%;
    background:linear-gradient(135deg,var(--lid) 0%,#4c18a5 100%);
    border-radius:12px 12px 6px 6px;
    box-shadow:0 6px 14px rgba(0,0,0,.25);
    transition:transform .7s cubic-bezier(.45,.1,.25,1.4);
  }
  .lid.open{
    transform:translate(-50%,0) rotateX(150deg);
  }

  /* Spring */
  .spring{
    position:absolute;
    bottom:160px;
    left:50%;
    width:14px;
    height:0;
    transform:translateX(-50%);
    background:
      repeating-linear-gradient(
        to bottom,
        var(--spring) 0 6px,
        transparent 6px 12px
      );
    filter:drop-shadow(0 0 2px rgba(0,0,0,.25));
    transition:height .55s cubic-bezier(.45,.05,.35,1.3);
    border-radius:6px;
  }

  /* Character */
  .character{
    position:absolute;
    bottom:160px;
    left:50%;
    width:110px;
    height:110px;
    transform:translate(-50%,0) scale(0);
    transform-origin:50% 100%;
    transition:
      transform .55s cubic-bezier(.35,1.6,.35,1.05),
      filter .25s;
    filter:drop-shadow(0 6px 10px rgba(0,0,0,.3));
  }
  .character.pop{
    transform:translate(-50%,0) scale(1);
  }

  /* Simple face */
  .face{
    position:relative;
    width:100%;
    height:100%;
    background:radial-gradient(circle at 35% 30%,#fff 0%,var(--char) 70%);
    border:4px solid var(--char-outline);
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    box-sizing:border-box;
  }
  .eye{
    position:absolute;
    width:14px;
    height:14px;
    background:#111;
    border-radius:50%;
    top:40%;
  }
  .eye.left{ left:30%; }
  .eye.right{ right:30%; }

  .mouth{
    width:34px;
    height:34px;
    background:#111;
    border-radius:50%;
    transition:transform .09s ease;
  }
  .mouth.speaking{
    transform:scaleY(.35) scaleX(1.15);
  }
  .mouth.wide{
    transform:scaleY(.75) scaleX(.9);
  }

  /* Shake animation while "thinking" */
  .thinking .box{
    animation:shakeBox .7s linear infinite;
  }
  @keyframes shakeBox{
    0%,100%{ transform:translateX(-50%) rotate(0deg); }
    20%{ transform:translateX(calc(-50% - 4px)) rotate(-2deg); }
    40%{ transform:translateX(calc(-50% + 4px)) rotate(2deg); }
    60%{ transform:translateX(calc(-50% - 3px)) rotate(-1.5deg); }
    80%{ transform:translateX(calc(-50% + 3px)) rotate(1.5deg); }
  }

  /* Floating confetti (simple) */
  .confetti{
    position:absolute;
    top:0;
    width:10px;
    height:10px;
    background:var(--c,#ffcc33);
    animation:fall 900ms ease-out forwards;
    border-radius:2px;
    pointer-events:none;
    mix-blend-mode:multiply;
  }
  @keyframes fall{
    0%{ transform:translateY(0) rotate(0deg); opacity:1; }
    100%{ transform:translateY(260px) rotate(540deg); opacity:0; }
  }

  /* CTA button */
  .trigger-btn{
    background:#8248ff;
    color:#fff;
    border:none;
    font-size:1.05rem;
    padding:14px 38px;
    border-radius:40px;
    cursor:pointer;
    letter-spacing:.4px;
    box-shadow:0 8px 20px -6px rgba(130,72,255,.55);
    transition:transform .2s, box-shadow .2s;
  }
  .trigger-btn:disabled{
    opacity:.5;
    cursor:not-allowed;
  }
  .trigger-btn:not(:disabled):hover{
    transform:translateY(-3px);
    box-shadow:0 14px 28px -6px rgba(130,72,255,.6);
  }
  .output{
    max-width:520px;
    min-height:48px;
    text-align:center;
    font-size:1.1rem;
    line-height:1.4;
    padding:10px 14px;
  }
  .output em{
    font-style:normal;
    background:linear-gradient(90deg,#ffbf49,#ff7f50);
    -webkit-background-clip:text;
    color:transparent;
  }

  .footer{
    font-size:.7rem;
    opacity:.5;
    margin-top:10px;
  }

  @media (max-width:520px){
    .stage{ transform:scale(.9); }
  }
</style>
</head>
<body>
  <main>
    <h1>Chubby Chunklet</h1>
    <p class="sub">Knock / pull the string to see what the little weirdo says.</p>

    <div class="stage" id="stage">
      <div class="lid" id="lid"></div>
      <div class="spring" id="spring"></div>
      <div class="box" id="box">
        <!-- box interior just empty -->
      </div>
      <div class="character" id="character">
        <div class="face">
          <div class="eye left"></div>
            <div class="mouth" id="mouth"></div>
          <div class="eye right"></div>
        </div>
      </div>
    </div>

    <div style="text-align:center;margin-top:8px;">
      <button id="trigger" class="trigger-btn" aria-label="Knock and get a line">Knock / Pull String</button>
    </div>

    <div id="output" class="output" aria-live="polite"></div>

    <div class="footer">
      Browser speech synthesis is used locally; nothing except the line request hits your server.
    </div>
  </main>

<script>
/* --- Config: replace with your deployed endpoint if it changes --- */
const ENDPOINT = 'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';

const triggerBtn = document.getElementById('trigger');
const stage      = document.getElementById('stage');
const lid        = document.getElementById('lid');
const spring     = document.getElementById('spring');
const character  = document.getElementById('character');
const mouth      = document.getElementById('mouth');
const outputEl   = document.getElementById('output');

let speakingInterval = null;

/* Utility: simple confetti */
function confettiBurst(){
  for(let i=0;i<18;i++){
    const span=document.createElement('span');
    span.className='confetti';
    span.style.setProperty('--c',['#ffcc33','#ff884d','#8248ff','#ff4fa2','#8ce0ff'][Math.random()*5|0]);
    span.style.left=(Math.random()*180 + 30)+'px';
    span.style.animationDelay=(Math.random()*0.25)+'s';
    stage.appendChild(span);
    setTimeout(()=>span.remove(),900);
  }
}

/* Mouth "animation" loop while speaking */
function startMouth(){
  clearInterval(speakingInterval);
  mouth.classList.add('speaking');
  speakingInterval=setInterval(()=>{
    // alternate between two shapes
    if(Math.random()<0.4){
      mouth.classList.toggle('wide');
    }else{
      mouth.classList.toggle('speaking');
      void mouth.offsetWidth;
      mouth.classList.add('speaking');
    }
  }, 130);
}
function stopMouth(){
  clearInterval(speakingInterval);
  mouth.classList.remove('speaking','wide');
}

/* Speech (falls back silently if unsupported) */
function speak(text){
  if(!('speechSynthesis' in window)){
    return; // silent fallback
  }
  const utter = new SpeechSynthesisUtterance(text);
  utter.rate = 1.0;
  utter.pitch = 1.02;
  utter.onstart = startMouth;
  utter.onend   = stopMouth;
  utter.onerror = stopMouth;
  // Try to prefer a neutral / US English voice if available
  const voices = speechSynthesis.getVoices();
  const preferred = voices.find(v=>/en-US/i.test(v.lang)&&/female/i.test(v.name)) ||
                    voices.find(v=>/en/i.test(v.lang));
  if(preferred) utter.voice = preferred;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

/* Animation flow */
async function pullString(){
  if(triggerBtn.disabled) return;
  triggerBtn.disabled = true;
  outputEl.textContent = '';

  // Reset / close
  lid.classList.remove('open');
  character.classList.remove('pop');
  spring.style.height='0px';
  stage.classList.add('thinking');

  let line = '';
  try{
    const res = await fetch(ENDPOINT);
    if(!res.ok) throw new Error('Network '+res.status);
    const data = await res.json();
    line = data.text || '(silence)';
  }catch(e){
    console.error(e);
    line = 'Static silence. (Network burp.)';
  }

  // Simulate "machination" delay even if fast
  await wait(400 + Math.random()*300);

  stage.classList.remove('thinking');
  lid.classList.add('open');

  await wait(180);
  spring.style.height='150px';

  await wait(160);
  character.classList.add('pop');
  confettiBurst();

  // Display text
  outputEl.innerHTML = `<em>${escapeHTML(line)}</em>`;
  speak(line);

  triggerBtn.disabled = false;
}

/* Helpers */
function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
function escapeHTML(s){
  return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
}

/* Event wiring */
triggerBtn.addEventListener('click', pullString);
stage.addEventListener('click', ()=>{
  // Clicking the stage also triggers (optional)
  pullString();
});

/* First prefetch (optional) — we won’t; user triggers explicitly */

/* Make sure voices are loaded (Chrome quirk) */
if('speechSynthesis' in window){
  speechSynthesis.onvoiceschanged = ()=>{};
}
</script>
</body>
</html>
