<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chubby Chunklet</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=Inter:wght@600;700&display=swap" rel="stylesheet">
<!-- DOS / terminal-style mono for the phrase line -->
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{
  --endpoint: https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet;

  --figure-scale:1.15;
  --mouth-top:133px;
  --mouth-left:50%;
  --mouth-w:38px;
  --mouth-h:38px;

  --mouth-scale-0:.05; /* initial; JS now drives actual levels */
  --char-ms:18;
  --terminal-color:#1034a6;

  --font-mono:'IBM Plex Mono',ui-monospace,Menlo,Consolas,monospace;
  --font-phrase:'Share Tech Mono','IBM Plex Mono',ui-monospace,Menlo,Consolas,monospace;

  /* Layout guardrails */
  --bottom-clearance: 120px; /* desired minimum pixels from phrase baseline to viewport bottom */
  --raise: 0px;              /* JS sets this dynamically */
}

/* ---------- layout ---------- */
*{box-sizing:border-box}
html,body{
  height:auto;margin:0;padding:0;
  font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:#fff;color:#111;
  -webkit-font-smoothing:antialiased;
}
body{
  display:flex;flex-direction:column;
  align-items:center;justify-content:flex-start;
  padding: 20px 18px 16px;
  overflow-x:hidden;
}
.wrapper{
  /* IMPORTANT: do not fill the remaining viewport height */
  flex:0 0 auto;
  width:100%;max-width:950px;
  display:flex;flex-direction:column;align-items:center;
  gap:22px;
  transform: translateY(calc(-1 * var(--raise)));
  will-change: transform;
}
.header{
  font-size:clamp(14px,1.8vw,20px);font-weight:600;letter-spacing:.4px;
  text-align:center;margin:0;
}
.header span{font-weight:700}

/* ---------- figure ---------- */
.figure-zone{
  display:flex;flex-direction:column;align-items:center;
  gap:22px;
  margin-top:-8px; /* nudge up */
}
.chunklet-wrap{
  position:relative;
  width:calc(180px*var(--figure-scale));
  height:calc(230px*var(--figure-scale));
  display:flex;align-items:flex-end;justify-content:center;
  pointer-events:none;
}
.chunklet-img{
  width:calc(170px*var(--figure-scale));max-width:100%;
  user-select:none;-webkit-user-drag:none;
  filter:drop-shadow(0 14px 34px rgba(0,0,0,.23));
  image-rendering:-webkit-optimize-contrast;
}
/* mouth overlay */
.mouth-overlay{
  position:absolute;
  top:var(--mouth-top);left:var(--mouth-left);
  width:var(--mouth-w);height:var(--mouth-h);
  transform:translate(-50%,-50%);
  display:flex;align-items:center;justify-content:center;
  pointer-events:none;
}
.mouth-overlay svg{width:100%;height:100%}
#mouth{transform-origin:50% 50%; transform:scale(1, var(--mouth-scale-0))}

/* ---------- button ---------- */
.trigger-button{border:none;background:transparent;padding:0;cursor:pointer;outline:none;-webkit-tap-highlight-color:transparent}
.trigger-button img{
  width:150px;height:auto;display:block; /* bigger tap target */
  transition:transform .10s cubic-bezier(.33,.9,.3,1),filter .12s;
  filter:drop-shadow(0 8px 22px rgba(0,0,0,.25)) drop-shadow(0 2px 4px rgba(0,0,0,.18))
}
.trigger-button:active img,
.trigger-button.pressed img{
  transform:translateY(8px) scale(.985);
  filter:drop-shadow(0 3px 9px rgba(0,0,0,.4)) brightness(.92) contrast(1.05)
}

/* ---------- output (phrase) ---------- */
.output{
  font-family:var(--font-phrase);
  text-transform:uppercase;                 /* ALL CAPS */
  font-size:clamp(16px, 1.6vw, 24px);       /* larger, DOS-like */
  line-height:1.28;
  letter-spacing:.08em;                     /* terminal-ish tracking */
  font-weight:400;                          /* Share Tech Mono weight */
  color:var(--terminal-color);
  max-width:760px;
  min-height:1.4em;
  text-align:left;
  margin:2px auto 0;
  white-space:pre-wrap;
  position:relative;
  text-shadow: 0 0 1px rgba(16,52,166,.4);  /* subtle phosphor glow */
}
.cursor{
  display:inline-block;
  width:.7ch;
  height:1em;
  background:var(--terminal-color);
  vertical-align:baseline;
  animation:blink 1s steps(1,end) infinite;
  transform:translateY(1px)
}
@keyframes blink{0%,55%{opacity:1}56%,100%{opacity:0}}
.typing .cursor{animation:none}
.output .work-tag{
  opacity:.7;
  font-family:var(--font-mono);
  text-transform:none;
  font-style:italic;
  margin-left:.6em;
  font-size:.85em;
  letter-spacing:.02em;
  font-weight:500;
}

/* ---------- small screens ---------- */
@media (pointer:coarse){
  body{ padding-bottom: max(64px, calc(8vh + env(safe-area-inset-bottom, 0px))); }
}
@media(max-height:640px){
  .figure-zone{gap:18px}
  .chunklet-wrap{height:calc(200px*var(--figure-scale))}
}
@media(max-width:360px){
  :root{--mouth-top:72px;--mouth-w:32px;--mouth-h:32px}
  .chunklet-wrap{width:calc(150px*var(--figure-scale));height:calc(200px*var(--figure-scale))}
  .chunklet-img{width:calc(140px*var(--figure-scale))}
  .trigger-button img{width:120px}
  .output{font-size:clamp(13px, 3.2vw, 18px)}
}
</style>
</head>
<body>
  <audio id="clickSnd" src="click.mp3" preload="auto"></audio>

  <div class="wrapper" id="wrapper">
    <h1 class="header">oh wow hey it's <span>chubby chunklet</span></h1>

    <div class="figure-zone">
      <div class="chunklet-wrap">
        <img src="littleboytalk.png" alt="Chubby Chunklet" class="chunklet-img" id="chunkletImg">
        <div class="mouth-overlay">
          <svg viewBox="0 0 100 100">
            <ellipse id="mouth" cx="50" cy="50" rx="26" ry="24" fill="#111"/>
          </svg>
        </div>
      </div>

      <button id="trigger" class="trigger-button" aria-label="Speak">
        <img id="keyImage" src="keycap.png" alt="Speak button">
      </button>
    </div>

    <div class="output" id="output">
      <span id="typed"></span><span id="cursor" class="cursor"></span>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const ENDPOINT = (document.documentElement.style.getPropertyValue('--endpoint')||'').trim()
  || 'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';
const QUERY    = '?style=canon&modern=1&accent=scottish';
const CHAR_MS  = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--char-ms'),10) || 20;

const trigger  = document.getElementById('trigger');
const typed    = document.getElementById('typed');
const cursor   = document.getElementById('cursor');
const mouth    = document.getElementById('mouth');
const output   = document.getElementById('output');
const clickSnd = document.getElementById('clickSnd');

const isIOS = /iP(hone|od|ad)|Macintosh.*Mobile/.test(navigator.userAgent);

/* ---------- state ---------- */
let busy=false;
let audioCtx,currentSource,audioEl,mediaSource,analyser,timeData;
let raf,animating=false,tagPlaying=false;
let currentObjectURL=null;
let iosAudioInitialized = false;

/* ===== multi-level fast flap (discrete bands with hysteresis) ===== */
const SY = [0.07, 0.55, 1.10, 1.70, 2.30];
const SX = [1.00, 1.01, 1.02, 1.02, 1.03];
const THRESH_UP   = [0.030, 0.060, 0.100, 0.160];
const HYST_DELTA  = 0.018;
const THRESH_DOWN = THRESH_UP.map(t => Math.max(0, t - HYST_DELTA));
const GATE_FLOOR  = 0.010;
const CLOSE_GRACE_MS = 20;
let level = 0, lastChange = 0;

/* ---------- layout auto-raise (keeps phrase off the bottom) ---------- */
function adjustLayout(){
  try{
    const outRect = output.getBoundingClientRect();
    const clearance = window.innerHeight - outRect.bottom;
    const need = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--bottom-clearance')) || 120;
    const raise = Math.max(0, need - clearance);
    document.documentElement.style.setProperty('--raise', raise + 'px');
  }catch(_){}
}
window.addEventListener('load', adjustLayout);
window.addEventListener('resize', adjustLayout);

/* ---------- audio/analyser helpers ---------- */
function ensureCtx(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') audioCtx.resume();
}
function ensureAnalyser(){
  ensureCtx();
  if(!analyser){
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    analyser.smoothingTimeConstant = 0.0;
    timeData = new Float32Array(analyser.fftSize);
  }
}
function attachAnalyserToBufferSource(srcNode){
  ensureAnalyser();
  try{ srcNode.disconnect(); }catch(_){}
  srcNode.connect(analyser);
  analyser.connect(audioCtx.destination);
}
function attachAnalyserToMediaElement(){
  ensureAnalyser();
  if(isIOS && !iosAudioInitialized){ initializeIOSAudio(); return; }
  if(!audioEl){
    audioEl = document.createElement('audio');
    audioEl.style.position = 'absolute';
    audioEl.style.left = '-9999px';
    audioEl.setAttribute('playsinline','');
    audioEl.setAttribute('webkit-playsinline','');
    document.body.appendChild(audioEl);
  }
  if(!mediaSource && audioCtx && audioEl){
    try{
      mediaSource = audioCtx.createMediaElementSource(audioEl);
      mediaSource.connect(analyser);
      analyser.connect(audioCtx.destination);
    }catch(e){ console.warn('createMediaElementSource failed', e); }
  }
}
function rmsLevel(){
  if(!analyser || !timeData) return 0;
  analyser.getFloatTimeDomainData(timeData);
  let sum = 0;
  for(let i=0;i<timeData.length;i++){ const v=timeData[i]; sum += v*v; }
  let rms = Math.sqrt(sum / timeData.length);
  if (rms < GATE_FLOOR) rms = 0;
  return rms;
}
function setLevel(n){
  n = Math.max(0, Math.min(4, n|0));
  if (n === level) return;
  level = n;
  mouth.style.transform = `scale(${SX[level]}, ${SY[level]})`;
  lastChange = performance.now();
}
function setClosed(){ setLevel(0); }
function startMouth(){ if(animating) return; animating = true; requestAnimationFrame(tick); }
function stopMouth(){ animating = false; cancelAnimationFrame(raf); setClosed(); }
function tick(){
  raf = requestAnimationFrame(tick);
  const active = !!currentSource || tagPlaying;
  const now = performance.now();
  if(active){
    if(analyser && (currentSource || (tagPlaying && mediaSource))){
      const e = rmsLevel();
      if(isIOS && e === 0 && tagPlaying){
        const t = (now/1000), phase = ((t*15)|0) % 5, levels=[1,2,3,2,1];
        setLevel(levels[phase]); return;
      }
      let target = level;
      while (target < 4 && e >= THRESH_UP[target]) target++;
      while (target > 0 && e < THRESH_DOWN[target-1]) target--;
      if (target < level && (now - lastChange) < CLOSE_GRACE_MS) target = level;
      setLevel(target);
    } else {
      const t = (now/1000), phase=((t*15)|0)%5, levels=[1,2,3,2,1];
      setLevel(levels[phase]);
    }
    return;
  }
  const t = (now/1000), phase=((t*13)|0)%4, rand=Math.random();
  const target = phase===0?0:phase===1?(rand<.7?1:2):phase===2?(rand<.6?2:3):(rand<.5?3:4);
  setLevel(target);
}

/* ---------- iOS unlock ---------- */
function initializeIOSAudio(){
  if(iosAudioInitialized) return;
  try{
    ensureCtx();
    if(!audioEl){
      audioEl = document.createElement('audio');
      audioEl.style.position='absolute'; audioEl.style.left='-9999px';
      audioEl.setAttribute('playsinline',''); audioEl.setAttribute('webkit-playsinline','');
      document.body.appendChild(audioEl);
    }
    const silentMP3='data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u////////////////////////////////////////////////////////AAAAAExhdmY1OC40NS4xMDAAAAAAAAAAAAAAAAAAAAAkAAAAAAAAAAAAYYZn5GDeAAAAAAD/+1DEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u////////////////////////////////////////////////////////AAAAAExhdmY1OC40NS4xMDAAAAAAAAAAAAAAAAAAAAAkAAAAAAAAAAABhmfkYN4AAAAAAP/7UMQAA8AAAGkAAAAIAAANIAAAARMQU1AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
    audioEl.src = silentMP3; audioEl.load();
    const p = audioEl.play();
    if(p!==undefined){
      p.then(()=>{
        audioEl.pause(); audioEl.currentTime=0;
        if(!mediaSource && audioCtx){
          try{
            mediaSource = audioCtx.createMediaElementSource(audioEl);
            ensureAnalyser(); mediaSource.connect(analyser); analyser.connect(audioCtx.destination);
            iosAudioInitialized = true;
          }catch(e){ console.warn('iOS audio init partial', e); }
        }
      }).catch(e=>console.warn('iOS audio init failed', e));
    }
  }catch(e){ console.warn('iOS audio initialization error:', e); }
}
function unlockAudioOnce(){
  try{
    ensureCtx();
    if(isIOS){ initializeIOSAudio(); }
    else {
      const buf = audioCtx.createBuffer(1,1,22050);
      const src = audioCtx.createBufferSource();
      src.buffer = buf; src.connect(audioCtx.destination); src.start(0);
    }
  }catch(_){}
  document.removeEventListener('touchstart', unlockAudioOnce);
  document.removeEventListener('click', unlockAudioOnce);
}
document.addEventListener('touchstart', unlockAudioOnce, {once:true, passive:true});
document.addEventListener('click', unlockAudioOnce, {once:true});

/* ---------- helpers ---------- */
const sanitize = txt=>{
  txt=(txt||'').trim().replace(/!+$/,'').replace(/\s+/g,' ');
  return /[.?!]$/.test(txt)?txt:txt+'.';
};

function typeOut(text, done){
  typed.textContent='';
  (function loop(i=0){
    typed.textContent = text.slice(0,i);
    if(i<text.length){
      if((i & 3) === 0) adjustLayout();    // keep lifting as the line grows
      setTimeout(()=>loop(i+1), CHAR_MS + ((i%7)?0:Math.random()*10));
    }else{
      adjustLayout();                       // final snap-to-clearance
      done && done();
    }
  })();
}

/* ---------- playback ---------- */
async function playAudio(b64,onEnd){
  if(isIOS){
    try{
      ensureCtx();
      if(!iosAudioInitialized){
        await initializeIOSAudio();
        await new Promise(r=>setTimeout(r,100));
      }
      attachAnalyserToMediaElement();
      const bin  = Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
      const blob = new Blob([bin], {type:'audio/mp3'});
      if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; }
      currentObjectURL = URL.createObjectURL(blob);
      if(!audioEl){
        audioEl = document.createElement('audio');
        audioEl.style.position='absolute'; audioEl.style.left='-9999px';
        audioEl.setAttribute('playsinline',''); audioEl.setAttribute('webkit-playsinline','');
        document.body.appendChild(audioEl);
      }
      audioEl.src = currentObjectURL; audioEl.load();
      audioEl.onplay  = ()=>{ setClosed(); startMouth(); tagPlaying=true; };
      audioEl.onended = ()=>{
        tagPlaying=false; stopMouth();
        if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; }
        onEnd && onEnd();
      };
      const p = audioEl.play(); if(p!==undefined) await p;
      return;
    }catch(err){
      console.error('iOS audio playback failed', err);
      startMouth();
      const approx = Math.min(7, Math.max(2.2, typed.textContent.length/16));
      setTimeout(()=>{ stopMouth(); onEnd && onEnd(); }, (approx+0.2)*1000);
      return;
    }
  }

  try{
    ensureCtx(); ensureAnalyser();
    const bin = Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
    const buf = await audioCtx.decodeAudioData(bin.buffer);
    currentSource = audioCtx.createBufferSource();
    currentSource.buffer = buf;
    currentSource.playbackRate.value = 1.08;
    attachAnalyserToBufferSource(currentSource);
    setClosed(); startMouth();
    currentSource.start();
    currentSource.onended = ()=>{ currentSource=null; stopMouth(); onEnd && onEnd(); };
    return;
  }catch(e){
    console.warn('WebAudio decode failed, fallback to <audio>', e);
  }

  try{
    ensureCtx(); ensureAnalyser(); attachAnalyserToMediaElement();
    const bin  = Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
    const blob = new Blob([bin], {type:'audio/mp3'});
    if(!audioEl){ audioEl = document.createElement('audio'); audioEl.hidden=true; document.body.appendChild(audioEl); }
    if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; }
    currentObjectURL = URL.createObjectURL(blob); audioEl.src = currentObjectURL;
    audioEl.onplay  = ()=>{ setClosed(); startMouth(); tagPlaying=true; };
    audioEl.onended = ()=>{ tagPlaying=false; stopMouth(); if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; } onEnd && onEnd(); };
    await audioEl.play();
  }catch(err){
    console.error('Plain <audio> failed', err);
    startMouth();
    const approx = Math.min(7, Math.max(2.2, typed.textContent.length/16));
    setTimeout(()=>{ stopMouth(); onEnd && onEnd(); }, (approx+0.2)*1000);
  }
}

function stopAudio(){
  if(currentSource){
    try{ currentSource.stop(); }catch(_){}
    try{ currentSource.disconnect(); }catch(_){}
    currentSource = null;
  }
  if(audioEl){
    try{ audioEl.pause(); audioEl.currentTime = 0; }catch(_){}
  }
  if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; }
  tagPlaying = false;
}

/* UI bits */
function showWork(work){
  if(!work) return;
  const old = output.querySelector('.work-tag'); 
  if(old) old.remove();
  const span = document.createElement('span');
  span.className = 'work-tag';
  span.textContent = '— ' + work;
  output.appendChild(span);
  adjustLayout(); // ensure tag didn't push us down
}

/* main */
const FETCH_URL = ENDPOINT + QUERY;

async function summon(){
  if(busy) return;

  try{ clickSnd.currentTime = 0; clickSnd.play(); }catch(_){}
  trigger.classList.add('pressed'); setTimeout(()=>trigger.classList.remove('pressed'), 160);

  busy = true;
  stopAudio();

  typed.textContent='';
  const oldTag = output.querySelector('.work-tag'); if(oldTag) oldTag.remove();
  adjustLayout();

  try{
    const res = await fetch(FETCH_URL, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const work = data.work || null;
    const text = sanitize(data.text);

    typeOut(text, async ()=>{
      const onEnd = ()=>{ showWork(work); };
      if(data.audioBase64){ await playAudio(data.audioBase64, onEnd); }
      else {
        startMouth();
        const approx = Math.min(7, Math.max(2.2, text.length/16));
        setTimeout(()=>{ stopMouth(); onEnd(); }, (approx+0.2)*1000);
      }
    });

  }catch(e){
    console.error(e);
    typeOut('A shy packet tripped. Try again.', adjustLayout);
  }finally{
    busy = false;
  }
}

trigger.addEventListener('click', summon);
document.addEventListener('keydown', e=>{
  if(e.key===' '||e.key==='Enter'){
    summon();
    if(document.activeElement!==trigger) trigger.focus();
  }
});

/* First paint guard */
adjustLayout();
</script>
</body>
</html>
