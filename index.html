<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chubby Chunklet</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@600;700&display=swap" rel="stylesheet">
<style>
:root {
  --endpoint: https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet;

  /* Figure scaling & mouth placement tweaks */
  --figure-scale:1.15;      /* make him a bit bigger (adjust 1.0â€“1.4) */
  --mouth-top:133px;
  --mouth-left:50%;
  --mouth-w:38px;
  --mouth-h:38px;

  /* Mouth open discrete scales (dramatic) */
  --mouth-scale-0:.05;
  --mouth-scale-1:.55;
  --mouth-scale-2:1.05;
  --mouth-scale-3:1.40;
  --mouth-scale-4:1.75;

  /* Typing + animation */
  --char-ms:18;
  --terminal-color:#1034a6; /* royal blue */
  --font-mono:'IBM Plex Mono',ui-monospace,Menlo,Consolas,monospace;
}

* { box-sizing:border-box; }
html,body {
  margin:0;
  padding:0;
  font-family:Inter, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto;
  background:#fff;
  color:#111;
  height:100%;
  -webkit-font-smoothing:antialiased;
}

body {
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding:28px 18px 32px;
}

.wrapper {
  flex:1;
  width:100%;
  max-width:950px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:38px;
}

.header {
  font-size:clamp(14px,1.9vw,20px);
  font-weight:600;
  letter-spacing:.4px;
  text-align:center;
  margin:0;
}
.header span { font-weight:700; }

.figure-zone {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:42px;
  margin-top:4px;
}

/* Figure */
.chunklet-wrap {
  position:relative;
  width:calc(180px * var(--figure-scale));
  height:calc(230px * var(--figure-scale));
  display:flex;
  align-items:flex-end;
  justify-content:center;
  pointer-events:none;
}
.chunklet-img {
  width:calc(170px * var(--figure-scale));
  max-width:100%;
  user-select:none;
  -webkit-user-drag:none;
  filter:drop-shadow(0 14px 34px rgba(0,0,0,.23));
  image-rendering:-webkit-optimize-contrast;
}

/* Mouth overlay */
.mouth-overlay {
  position:absolute;
  top:var(--mouth-top);
  left:var(--mouth-left);
  width:var(--mouth-w);
  height:var(--mouth-h);
  transform:translate(-50%,-50%);
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}
.mouth-overlay svg { width:100%; height:100%; }
#mouth {
  transform-origin:50% 50%;
  transform:scaleY(var(--mouth-scale-0));
}

/* Button */
.trigger-button {
  position:relative;
  border:none;
  background:transparent;
  padding:0;
  cursor:pointer;
  outline:none;
  -webkit-tap-highlight-color:transparent;
  display:block;
}
.trigger-button img {
  width:118px;
  height:auto;
  display:block;
  transition:transform .10s cubic-bezier(.33,.9,.3,1), filter .12s;
  filter:drop-shadow(0 8px 22px rgba(0,0,0,.25)) drop-shadow(0 2px 4px rgba(0,0,0,.18));
}
.trigger-button:active img,
.trigger-button.pressed img {
  transform:translateY(8px) scale(.985);
  filter:drop-shadow(0 3px 9px rgba(0,0,0,.4)) brightness(.92) contrast(1.05);
}

/* Output line (smaller) */
.output {
  font-family:var(--font-mono);
  font-size:clamp(9px,0.8vw,12px); /* much smaller */
  line-height:1.3;
  letter-spacing:.4px;
  color:var(--terminal-color);
  max-width:620px;
  min-height:1.6em;
  text-align:left;
  margin:8px auto 0;
  white-space:pre-wrap;
  position:relative;
  font-weight:500;
}
.cursor {
  display:inline-block;
  width:.55ch;
  background:var(--terminal-color);
  height:1em;
  vertical-align:baseline;
  animation:blink 1s steps(1,end) infinite;
  transform:translateY(1px);
}
.typing .cursor { animation:none; }

@keyframes blink {
  0%,55% {opacity:1;}
  56%,100% {opacity:0;}
}

/* Idle tiny pulse */
body.idle #mouth { animation:idleMouth 1.2s ease-in-out infinite; }
@keyframes idleMouth {
  0%,100% { transform:scaleY(.14); }
  50% { transform:scaleY(.28); }
}

@media (max-height:640px){
  .figure-zone { gap:30px; }
  .chunklet-wrap { height:calc(200px * var(--figure-scale)); }
}
@media (max-width:360px){
  :root {
    --mouth-top:72px;
    --mouth-w:32px;
    --mouth-h:32px;
  }
  .chunklet-wrap { width:calc(150px * var(--figure-scale)); height:calc(200px * var(--figure-scale)); }
  .chunklet-img { width:calc(140px * var(--figure-scale)); }
  .trigger-button img { width:96px; }
}
</style>
</head>
<body class="idle">
  <div class="wrapper">
    <h1 class="header">oh wow hey it's <span>chubby chunklet</span></h1>

    <div class="figure-zone">
      <div class="chunklet-wrap">
        <img src="littlemantalk.png" alt="Chubby Chunklet" class="chunklet-img" id="chunkletImg">
        <div class="mouth-overlay">
          <svg viewBox="0 0 100 100">
            <ellipse id="mouth" cx="50" cy="50" rx="26" ry="24" fill="#111"/>
          </svg>
        </div>
      </div>

      <button id="trigger" class="trigger-button" aria-label="Speak">
        <img id="keyImage" src="button.png" alt="Speak button">
      </button>
    </div>

    <div class="output" id="output"><span id="typed"></span><span id="cursor" class="cursor"></span></div>
  </div>

<script>
/* ============= CONFIG ============= */
const ENDPOINT = (document.documentElement.style.getPropertyValue('--endpoint') || '').trim() ||
  'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';
const CHAR_MS = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--char-ms'),10) || 20;

/* Faster stop-motion FPS */
const STOP_MOTION_FPS = 16; // (higher = quicker flashing)
const FRAME_INTERVAL = 1 / STOP_MOTION_FPS;

/* Discrete mouth scales from CSS vars */
const OPEN_STEPS = [
  '--mouth-scale-0','--mouth-scale-1','--mouth-scale-2','--mouth-scale-3','--mouth-scale-4'
].map(v => parseFloat(getComputedStyle(document.documentElement).getPropertyValue(v)));

const trigger   = document.getElementById('trigger');
const typedSpan = document.getElementById('typed');
const cursor    = document.getElementById('cursor');
const mouth     = document.getElementById('mouth');

let busy=false, typing=false;
let audioCtx, currentSource, startTime=0, timings=[];
let raf, lastFrameTime=0;

function sanitize(text){
  text=(text||'').trim();
  if(!text) text='A stealthy dust mote drafted a manifesto while you blinked';
  text=text.replace(/!+$/,'').replace(/\s+/g,' ').trim();
  return /[.?!]$/.test(text)?text:text+'.';
}

/* Typing */
function typeOut(text, done){
  typing=true;
  document.getElementById('output').classList.add('typing');
  typedSpan.textContent='';
  let i=0;
  (function step(){
    typedSpan.textContent = text.slice(0,i);
    i++;
    if(i<=text.length){
      const jitter = (i%7===0)? Math.random()*10 : 0;
      setTimeout(step, CHAR_MS + jitter);
    } else {
      typing=false;
      document.getElementById('output').classList.remove('typing');
      done&&done();
    }
  })();
}

/* Audio Handling */
function ensureCtx(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
  if(audioCtx.state==='suspended') audioCtx.resume();
}

async function playAudio(b64){
  ensureCtx();
  const raw = atob(b64.replace(/^data:audio\/[a-zA-Z0-9.+-]+;base64,/, ''));
  const buf = new Uint8Array(raw.length);
  for(let i=0;i<raw.length;i++) buf[i]=raw.charCodeAt(i);
  const decoded = await audioCtx.decodeAudioData(buf.buffer);
  currentSource = audioCtx.createBufferSource();
  currentSource.buffer = decoded;
  currentSource.connect(audioCtx.destination);
  startTime = audioCtx.currentTime;
  startMouth();
  currentSource.start();
  currentSource.onended = stopMouth;
}

function stopAudio(){
  if(currentSource){
    try{ currentSource.stop(); }catch{}
    currentSource.disconnect();
    currentSource=null;
  }
}

/* Fabricated timings (rapid, random) */
function fabricateTimings(text){
  const duration = Math.min(7, Math.max(2.2, text.length/16));
  const frames = Math.round(duration * STOP_MOTION_FPS);
  const step = duration / frames;
  timings=[];
  for(let i=0;i<=frames;i++){
    // Weighted random: often big or tiny for chunky stop motion
    const r=Math.random();
    let open;
    if(r<0.15) open=0.05;
    else if(r<0.30) open=0.35;
    else if(r<0.60) open=0.7;
    else if(r<0.85) open=0.9;
    else open=1;
    timings.push({t:i*step, open});
  }
}

/* Mouth animation */
function quantize(open){
  const idx = Math.min(4, Math.max(0, Math.round(open*4)));
  return OPEN_STEPS[idx];
}

function startMouth(){
  document.body.classList.remove('idle');
  cancelAnimationFrame(raf);
  lastFrameTime=0;
  animateMouth();
}

function stopMouth(){
  cancelAnimationFrame(raf);
  mouth.style.transform=`scaleY(${OPEN_STEPS[0]})`;
  document.body.classList.add('idle');
}

function animateMouth(now){
  raf=requestAnimationFrame(animateMouth);
  if(!now) return;
  if(!lastFrameTime) lastFrameTime=now;
  const elapsed = (now-lastFrameTime)/1000;
  if(elapsed < FRAME_INTERVAL) return; // throttle to stop-motion FPS
  lastFrameTime=now;

  const t = audioCtx && currentSource ? (audioCtx.currentTime - startTime) : (performance.now()/1000);
  let open=0.1;
  if(timings.length){
    for(let i=0;i<timings.length;i++){
      if(t >= timings[i].t) open=timings[i].open; else break;
    }
  } else {
    open=(Math.random()>0.5)?1:0.15;
  }
  mouth.style.transform=`scaleY(${quantize(open)})`;
}

/* Fetch line */
async function summon(){
  if(busy) return;
  busy=true;
  trigger.classList.add('pressed');
  stopAudio(); stopMouth();
  typedSpan.textContent='';
  cursor.classList.remove('hidden');

  try{
    const res = await fetch(ENDPOINT + '?style=shakespeare'); // hint to backend
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    let text = sanitize(data.text);
    timings = Array.isArray(data.timings)? data.timings : [];
    typeOut(text, async ()=>{
      if(data.audioBase64){
        if(!timings.length) fabricateTimings(text);
        await playAudio(data.audioBase64);
      } else {
        fabricateTimings(text);
        startMouth();
        setTimeout(stopMouth, 3500);
      }
    });
  }catch(e){
    console.error(e);
    typeOut('A shy packet tripped. Try again.');
  }finally{
    setTimeout(()=>trigger.classList.remove('pressed'),140);
    busy=false;
  }
}

trigger.addEventListener('click', summon);
document.addEventListener('keydown', e=>{
  if(e.key===' '||e.key==='Enter'){
    summon();
    if(document.activeElement!==trigger) trigger.focus();
  }
});
</script>
</body>
</html>
