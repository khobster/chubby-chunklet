<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>chubby chunklet</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=Inter:wght@600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap" rel="stylesheet">

  <style>
  :root{
    --endpoint: https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet;

    --figure-scale:1.15;

    /* mouth tweak (was ~42%) */
    --mouth-top:39.5%;
    --mouth-left:50%;
    --mouth-w:20px;
    --mouth-h:20px;

    --mouth-scale-0:.05;
    --char-ms:18;

    --bubble-bg:#fff;
    --bubble-fg:#111;
    --bubble-border:#111;
    --jeopardy-blue:#0033CC; /* kept if you want to flip back */

    --font-mono:'IBM Plex Mono',ui-monospace,Menlo,Consolas,monospace;
    --font-phrase:'Patrick Hand', 'Comic Sans MS', 'Comic Neue', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;

    --door-open-ms:2200; /* JS uses DOOR_MS; keep synced if changed */
    --trot-ms:1500;
  }

  /* ---------- layout ---------- */
  *{box-sizing:border-box}
  html,body{
    margin:0;padding:0;
    font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
    background:#000;
    color:#fff;
    -webkit-font-smoothing:antialiased;
    overflow:hidden;
    height:100%;
    width:100%;
  }

  /* Scene background - full screen */
  .scene-container{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#4a7ba7; /* Sky blue fallback */
  }

  .scene-bg{
    width:100%;
    height:100%;
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .scene-bg img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }

  /* Door container */
  .door-container{
    position:absolute;
    top:50%;
    left:50%;
    width:140px;
    height:180px;
    transform:translate(-50%, -30px);
    cursor:pointer;
    z-index:10;
    perspective:900px;
  }

  .door-left, .door-right{
    position:absolute;
    width:50%;
    height:100%;
    background:#3d2418;
    border:3px solid #2d1810;
    transition:transform 2.2s cubic-bezier(.22,.61,.36,1);
    box-shadow:
      inset 0 0 20px rgba(0,0,0,0.4),
      0 0 10px rgba(0,0,0,0.8);
    backface-visibility:hidden;
  }

  .door-left{
    left:0;
    transform-origin:left center;
    border-right:2px solid #1a0e08;
  }

  .door-right{
    right:0;
    transform-origin:right center;
    border-left:2px solid #1a0e08;
  }

  .door-panel{
    position:absolute;
    background:#2d1810;
    border:2px solid #1a0e08;
    box-shadow:
      inset 2px 2px 4px rgba(0,0,0,0.4),
      inset -1px -1px 2px rgba(61,36,24,0.3);
  }

  .door-left .panel-top{ width:65%; height:22%; top:15%; left:17.5%;}
  .door-left .panel-mid{  width:65%; height:22%; top:41%; left:17.5%;}
  .door-left .panel-bottom{width:65%; height:22%; top:67%; left:17.5%;}
  .door-right .panel-top{ width:65%; height:22%; top:15%; right:17.5%;}
  .door-right .panel-mid{  width:65%; height:22%; top:41%; right:17.5%;}
  .door-right .panel-bottom{width:65%; height:22%; top:67%; right:17.5%;}

  .door-open .door-left{ transform:rotateY(85deg); }
  .door-open .door-right{ transform:rotateY(-85deg); }

  /* Chunklet character */
  .chunklet-container{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -30px);
    opacity:0;
    transition:opacity 0.35s;
    z-index:5;
    pointer-events:none;
  }
  .chunklet-container.active{ opacity:1; }

  /* Bouncy trot animation (duration set by class) */
  @keyframes bouncyTrot {
    0% { transform:translate(-50%, -30px) }
    5% { transform:translate(-50%, -25px) rotate(-2deg) }
    10% { transform:translate(-50%, -20px) }
    15% { transform:translate(-50%, -15px) rotate(2deg) }
    20% { transform:translate(-50%, -10px) }
    25% { transform:translate(-50%, -5px) rotate(-2deg) }
    30% { transform:translate(-50%, 0px) }
    35% { transform:translate(-50%, 5px) rotate(2deg) }
    40% { transform:translate(-50%, 10px) }
    45% { transform:translate(-50%, 15px) rotate(-2deg) }
    50% { transform:translate(-50%, 20px) }
    55% { transform:translate(-50%, 25px) rotate(2deg) }
    60% { transform:translate(-50%, 30px) }
    65% { transform:translate(-50%, 35px) rotate(-2deg) }
    70% { transform:translate(-50%, 40px) }
    75% { transform:translate(-50%, 45px) rotate(2deg) }
    80% { transform:translate(-50%, 50px) }
    85% { transform:translate(-50%, 55px) rotate(-1deg) }
    90% { transform:translate(-50%, 60px) }
    95% { transform:translate(-50%, 65px) }
    100% { transform:translate(-50%, 70px) }
  }
  .chunklet-container.trotting{
    animation:bouncyTrot var(--trot-ms) ease-out forwards;
    animation-duration: calc(var(--trot-ms) * 1ms);
  }

  .chunklet-wrap{
    position:relative;
    width:calc(100px*var(--figure-scale));
    height:calc(130px*var(--figure-scale));
    display:flex;
    align-items:flex-end;
    justify-content:center;
  }
  .chunklet-img{
    width:calc(90px*var(--figure-scale));
    max-width:100%;
    user-select:none;
    -webkit-user-drag:none;
    filter:drop-shadow(0 8px 16px rgba(0,0,0,.6));
    image-rendering:-webkit-optimize-contrast;
  }

  /* Mouth overlay */
  .mouth-overlay{
    position:absolute;
    top:var(--mouth-top);
    left:var(--mouth-left);
    width:var(--mouth-w);
    height:var(--mouth-h);
    transform:translate(-50%,-50%);
    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none;
  }
  .mouth-overlay svg{width:100%;height:100%}
  #mouth{transform-origin:50% 50%; transform:scale(1, var(--mouth-scale-0))}

  /* ======= Speech bubble ======= */
  .output-container{
    position:absolute;
    /* position above-right of door/center */
    top: calc(50% - 190px);
    left: calc(50% + 170px);
    width:min(560px, 80vw);
    z-index:20;
    opacity:0;
    transition:opacity 0.45s;
    pointer-events:none;
  }
  .output-container.active{ opacity:1; }

  .speech-bubble{
    position:relative;
    background:var(--bubble-bg);
    color:var(--bubble-fg);
    border:3px solid var(--bubble-border);
    border-radius:22px;
    padding:18px 22px;
    box-shadow:
      0 8px 30px rgba(0,0,0,.35),
      inset 0 -2px 0 rgba(0,0,0,.04);
  }
  /* Tail pointing toward Chunklet */
  .speech-bubble::after{
    content:'';
    position:absolute;
    left:-14px;
    bottom:28px;
    width:22px;
    height:22px;
    background:var(--bubble-bg);
    border-left:3px solid var(--bubble-border);
    border-bottom:3px solid var(--bubble-border);
    transform:skewY(10deg) rotate(45deg);
    box-shadow:-6px 6px 12px rgba(0,0,0,.08);
  }

  .output{
    font-family:var(--font-phrase);
    text-transform:none;
    font-size:clamp(18px, 2.6vw, 28px);
    line-height:1.2;
    letter-spacing:0.01em; /* tighter */
    font-weight:400;        /* thinner */
    color:var(--bubble-fg);
    text-shadow:none;
    text-align:left;
    margin:0;
    white-space:pre-wrap;
    position:relative;
  }

  .cursor{
    display:inline-block;
    width:.45ch;
    height:1.05em;
    background:var(--bubble-fg);
    vertical-align:text-bottom;
    animation:blink 1s steps(1,end) infinite;
  }
  @keyframes blink{0%,55%{opacity:1}56%,100%{opacity:0}}
  .typing .cursor{animation:none}

  .output .work-tag{
    opacity:.9;
    font-family: var(--font-phrase);
    text-transform: none;
    font-style: normal;
    margin-left:0;
    font-size:.9em;
    letter-spacing:.01em;
    font-weight: 400;
    color:#333;
    display:block;
    margin-top:12px;
  }

  /* Floating controls */
  .ui-controls{
    position:fixed;
    top:14px;
    right:14px;
    z-index:1000;
    display:flex;
    gap:10px;
  }
  .pill{
    appearance:none;
    border:1px solid rgba(255,255,255,.3);
    background:rgba(0,0,0,.35);
    color:#fff;
    font:600 12px/1 Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    padding:8px 12px;
    border-radius:999px;
    letter-spacing:.04em;
    backdrop-filter: blur(4px);
    cursor:pointer;
    transition:transform .06s ease, background .2s ease, border-color .2s ease;
  }
  .pill:hover{ transform:translateY(-1px); background:rgba(255,255,255,.08) }
  .pill:active{ transform:translateY(0); }
  .pill[aria-pressed="true"]{ border-color:#66e; background:rgba(102,102,238,.15); }

  /* Mobile adjustments */
  @media(max-width:900px){
    .output-container{
      top: 32px;
      left: 50%;
      transform: translateX(-50%);
      width: 92vw;
    }
    .speech-bubble::after{
      left: 22px;
      bottom: -10px;
      transform: rotate(45deg);
      border-left:3px solid var(--bubble-border);
      border-bottom:3px solid var(--bubble-border);
    }
  }
  @media(max-width:600px){
    .door-container{ width:100px; height:130px; }
    .chunklet-container.active{ transform:translate(-50%, 50px); }
    .output{ font-size:clamp(16px, 4vw, 22px); }
  }
  </style>
</head>
<body>
  <audio id="clickSnd"  src="click.mp3" preload="auto"></audio>
  <audio id="swellSnd"  src="door_swell.mp3" preload="auto"></audio>

  <div class="scene-container">
    <div class="scene-bg">
      <img src="skullbones.png" alt="Scene background">

      <!-- Interactive door -->
      <div class="door-container" id="doorTrigger">
        <div class="door-left">
          <div class="door-panel panel-top"></div>
          <div class="door-panel panel-mid"></div>
          <div class="door-panel panel-bottom"></div>
        </div>
        <div class="door-right">
          <div class="door-panel panel-top"></div>
          <div class="door-panel panel-mid"></div>
          <div class="door-panel panel-bottom"></div>
        </div>
      </div>

      <!-- Chunklet character -->
      <div class="chunklet-container" id="chunkletContainer">
        <div class="chunklet-wrap">
          <img src="littleboytalk.png" alt="Chubby Chunklet" class="chunklet-img">
          <div class="mouth-overlay">
            <svg viewBox="0 0 100 100">
              <ellipse id="mouth" cx="50" cy="50" rx="26" ry="24" fill="#111"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- Speech bubble (kept clear of Chunklet) -->
      <div class="output-container" id="outputContainer">
        <div class="speech-bubble">
          <div class="output" id="output">
            <span id="typed"></span><span id="cursor" class="cursor"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="ui-controls">
    <button id="freezeBtn" class="pill">Freeze</button>
    <button id="replayBtn" class="pill" title="Replay audio">Replay</button>
    <button id="copyBtn"   class="pill" title="Copy phrase">Copy</button>
  </div>

<script>
/* ===== CONFIG ===== */
const ENDPOINT = (document.documentElement.style.getPropertyValue('--endpoint')||'').trim()
  || 'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';
const QUERY    = '?style=canon&modern=0&accent=scottish';
const CHAR_MS  = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--char-ms'),10) || 20;

const DOOR_MS  = 2200; // keep in sync with CSS transition above
const TROT_MS  = 1500;

const doorTrigger       = document.getElementById('doorTrigger');
const chunkletContainer = document.getElementById('chunkletContainer');
const outputContainer   = document.getElementById('outputContainer');
const typed    = document.getElementById('typed');
const cursor   = document.getElementById('cursor');
const mouth    = document.getElementById('mouth');
const output   = document.getElementById('output');
const clickSnd = document.getElementById('clickSnd');
const swellSnd = document.getElementById('swellSnd');

const freezeBtn = document.getElementById('freezeBtn');
const replayBtn = document.getElementById('replayBtn');
const copyBtn   = document.getElementById('copyBtn');

const isIOS = /iP(hone|od|ad)|Macintosh.*Mobile/.test(navigator.userAgent);

/* ---------- state ---------- */
let busy=false;
let doorOpen=false;
let frozen=false;

let audioCtx,currentSource,audioEl,mediaSource,analyser,timeData;
let raf,animating=false,tagPlaying=false;
let currentObjectURL=null;
let iosAudioInitialized = false;

/* ===== multi-level fast flap (discrete bands with hysteresis) ===== */
const SY = [0.07, 0.55, 1.10, 1.70, 2.30];
const SX = [1.00, 1.01, 1.02, 1.02, 1.03];
const THRESH_UP   = [0.030, 0.060, 0.100, 0.160];
const HYST_DELTA  = 0.018;
const THRESH_DOWN = THRESH_UP.map(t => Math.max(0, t - HYST_DELTA));
const GATE_FLOOR  = 0.010;
const CLOSE_GRACE_MS = 20;

let level = 0;
let lastChange = 0;

function ensureCtx(){
  if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state === 'suspended') audioCtx.resume();
}
function ensureAnalyser(){
  ensureCtx();
  if(!analyser){
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 256;
    analyser.smoothingTimeConstant = 0.0;
    timeData = new Float32Array(analyser.fftSize);
  }
}
function attachAnalyserToBufferSource(srcNode){
  ensureAnalyser();
  try{ srcNode.disconnect(); }catch(_){}
  srcNode.connect(analyser);
  analyser.connect(audioCtx.destination);
}
function attachAnalyserToMediaElement(){
  ensureAnalyser();
  if(isIOS && !iosAudioInitialized){
    initializeIOSAudio();
    return;
  }
  if(!audioEl){
    audioEl = document.createElement('audio');
    audioEl.style.position = 'absolute';
    audioEl.style.left = '-9999px';
    audioEl.setAttribute('playsinline', '');
    audioEl.setAttribute('webkit-playsinline', '');
    document.body.appendChild(audioEl);
  }
  if(!mediaSource && audioCtx && audioEl){
    try{
      mediaSource = audioCtx.createMediaElementSource(audioEl);
      mediaSource.connect(analyser);
      analyser.connect(audioCtx.destination);
    }catch(e){ console.warn('createMediaElementSource failed', e); }
  }
}
function rmsLevel(){
  if(!analyser || !timeData) return 0;
  analyser.getFloatTimeDomainData(timeData);
  let sum = 0;
  for(let i=0;i<timeData.length;i++){
    const v = timeData[i];
    sum += v*v;
  }
  let rms = Math.sqrt(sum / timeData.length);
  if (rms < GATE_FLOOR) rms = 0;
  return rms;
}
function setLevel(n){
  n = Math.max(0, Math.min(4, n|0));
  if (n === level) return;
  level = n;
  mouth.style.transform = `scale(${SX[level]}, ${SY[level]})`;
  lastChange = performance.now();
}
function setClosed(){ setLevel(0); }
function startMouth(){
  if(animating) return;
  animating = true;
  requestAnimationFrame(tick);
}
function stopMouth(){
  animating = false;
  cancelAnimationFrame(raf);
  setClosed();
}
function tick(){
  raf = requestAnimationFrame(tick);
  const active = !!currentSource || tagPlaying;
  const now = performance.now();
  if(active){
    if(analyser && (currentSource || (tagPlaying && mediaSource))){
      const e = rmsLevel();
      let target = level;
      while (target < 4 && e >= THRESH_UP[target]) target++;
      while (target > 0 && e < THRESH_DOWN[target-1]) target--;
      if (target < level && (now - lastChange) < CLOSE_GRACE_MS) target = level;
      setLevel(target);
    } else {
      const phase = ((now/1000*15)|0) % 5;
      setLevel([1,2,3,2,1][phase]);
    }
    return;
  }
  const phase = ((now/1000*13)|0) % 4;
  const rand = Math.random();
  const target = phase === 0 ? 0
              : phase === 1 ? (rand < .7 ? 1 : 2)
              : phase === 2 ? (rand < .6 ? 2 : 3)
              :               (rand < .5 ? 3 : 4);
  setLevel(target);
}

/* iOS unlock */
function initializeIOSAudio(){
  if(iosAudioInitialized) return;
  try{
    ensureCtx();
    if(!audioEl){
      audioEl = document.createElement('audio');
      audioEl.style.position = 'absolute';
      audioEl.style.left = '-9999px';
      audioEl.setAttribute('playsinline', '');
      audioEl.setAttribute('webkit-playsinline', '');
      document.body.appendChild(audioEl);
    }
    const silentMP3 = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u////////////////////////////////////////////////////////AAAAAExhdmY1OC40NS4xMDAAAAAAAAAAAAAAAAAAAAAkAAAAAAAAAAAAYYZn5GDeAAAAAAD/+1DEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u////////////////////////////////////////////////////////AAAAAExhdmY1OC40NS4xMDAAAAAAAAAAAAAAAAAAAAAkAAAAAAAAAAABhmfkYN4AAAAAAP/7UMQAA8AAAGkAAAAIAAANIAAAARMQU1AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
    audioEl.src = silentMP3;
    audioEl.load();
    const playPromise = audioEl.play();
    if(playPromise !== undefined){
      playPromise.then(() => {
        audioEl.pause(); audioEl.currentTime = 0;
        if(!mediaSource && audioCtx){
          try{
            mediaSource = audioCtx.createMediaElementSource(audioEl);
            ensureAnalyser();
            mediaSource.connect(analyser);
            analyser.connect(audioCtx.destination);
            iosAudioInitialized = true;
          }catch(e){ console.warn('iOS audio init partial success, no analyser:', e); }
        }
      }).catch(e => { console.warn('iOS audio init failed:', e); });
    }
  }catch(e){ console.warn('iOS audio initialization error:', e); }
}
function unlockAudioOnce(){
  try{
    ensureCtx();
    if(isIOS){ initializeIOSAudio(); }
    else{
      const buf = audioCtx.createBuffer(1,1,22050);
      const src = audioCtx.createBufferSource();
      src.buffer = buf; src.connect(audioCtx.destination); src.start(0);
    }
  }catch(_){}
  document.removeEventListener('touchstart', unlockAudioOnce);
  document.removeEventListener('click', unlockAudioOnce);
}
document.addEventListener('touchstart', unlockAudioOnce, {once:true, passive:true});
document.addEventListener('click', unlockAudioOnce, {once:true});

/* helpers */
const sanitize = txt=>{
  txt=(txt||'').trim().replace(/!+$/,'').replace(/\s+/g,' ');
  return /[.?!]$/.test(txt)?txt:txt+'.';
};

function typeOut(text, done){
  typed.textContent='';
  output.classList.add('typing');
  (function loop(i=0){
    typed.textContent = text.slice(0,i);
    if(i<text.length){
      setTimeout(()=>loop(i+1), CHAR_MS + ((i%7)?0:Math.random()*10));
    }else{
      output.classList.remove('typing');
      done && done();
    }
  })();
}

/* playback */
function playSwell(){
  try{
    swellSnd.currentTime = 0;
    swellSnd.volume = 1;
    swellSnd.play();
  }catch(_){}
}
function fadeOut(el, ms=800){
  if(!el) return;
  const startVol = el.volume ?? 1;
  const start = performance.now();
  function step(t){
    const k = Math.min(1, (t - start) / ms);
    const v = startVol * (1 - k);
    el.volume = Math.max(0, v);
    if(k < 1) requestAnimationFrame(step); else { try{ el.pause(); }catch(_){} }
  }
  requestAnimationFrame(step);
}

async function playAudio(b64,onEnd){
  if(isIOS){
    try{
      ensureCtx(); 
      if(!iosAudioInitialized){
        await initializeIOSAudio();
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      attachAnalyserToMediaElement();
      const bin  = Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
      const blob = new Blob([bin], {type:'audio/mp3'});
      if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; }
      currentObjectURL = URL.createObjectURL(blob);
      if(!audioEl){
        audioEl = document.createElement('audio');
        audioEl.style.position = 'absolute';
        audioEl.style.left = '-9999px';
        audioEl.setAttribute('playsinline', '');
        audioEl.setAttribute('webkit-playsinline', '');
        document.body.appendChild(audioEl);
      }
      audioEl.src = currentObjectURL;
      audioEl.load();
      audioEl.onplay  = ()=>{ setClosed(); startMouth(); tagPlaying=true; };
      audioEl.onended = ()=>{
        tagPlaying=false; stopMouth();
        if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; }
        onEnd && onEnd();
      };
      const playPromise = audioEl.play(); if(playPromise !== undefined){ await playPromise; }
      return;
    }catch(err){
      console.error('iOS audio playback failed', err);
      startMouth();
      const approx = Math.min(7, Math.max(2.2, typed.textContent.length/16));
      setTimeout(()=>{ stopMouth(); onEnd && onEnd(); }, (approx+0.2)*1000);
      return;
    }
  }
  try{
    ensureCtx(); ensureAnalyser();
    const bin = Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
    const buf = await audioCtx.decodeAudioData(bin.buffer);
    currentSource = audioCtx.createBufferSource();
    currentSource.buffer = buf;
    currentSource.playbackRate.value = 1.08;
    attachAnalyserToBufferSource(currentSource);
    setClosed(); startMouth();
    currentSource.start();
    currentSource.onended = ()=>{ currentSource=null; stopMouth(); onEnd && onEnd(); };
    return;
  }catch(e){
    console.warn('WebAudio decode failed, fallback to <audio>', e);
  }
  try{
    ensureCtx(); ensureAnalyser(); attachAnalyserToMediaElement();
    const bin  = Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
    const blob = new Blob([bin], {type:'audio/mp3'});
    if(!audioEl){
      audioEl = document.createElement('audio');
      audioEl.hidden = true;
      document.body.appendChild(audioEl);
    }
    if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; }
    currentObjectURL = URL.createObjectURL(blob);
    audioEl.src = currentObjectURL;
    audioEl.onplay  = ()=>{ setClosed(); startMouth(); tagPlaying=true; };
    audioEl.onended = ()=>{
      tagPlaying=false; stopMouth();
      if(currentObjectURL){ URL.revokeObjectURL(currentObjectURL); currentObjectURL=null; }
      onEnd && onEnd();
    };
    await audioEl.play();
  }catch(err){
    console.error('Plain <audio> failed', err);
    startMouth();
    const approx = Math.min(7, Math.max(2.2, typed.textContent.length/16));
    setTimeout(()=>{ stopMouth(); onEnd && onEnd(); }, (approx+0.2)*1000);
  }
}

function stopAudio(){
  if(currentSource){
    try{ currentSource.stop(); }catch(_){}
    try{ currentSource.disconnect(); }catch(_){}
    currentSource = null;
  }
  if(audioEl){
    try{ audioEl.pause(); audioEl.currentTime = 0; }catch(_){}
  }
  if(currentObjectURL){ 
    URL.revokeObjectURL(currentObjectURL); 
    currentObjectURL=null; 
  }
  tagPlaying = false;
}

/* UI bits */
function showWork(work, author){
  const old = output.querySelector('.work-tag'); 
  if(old) old.remove();
  if(!work && !author) return;
  const span = document.createElement('span');
  span.className = 'work-tag';
  span.textContent = '— ' + [work, author].filter(Boolean).join(' · ');
  output.appendChild(span);
}

/* Door animation */
function openDoor(){
  if(doorOpen) return;
  doorOpen = true;
  doorTrigger.classList.add('door-open');

  // dramatic swell as door opens
  playSwell();

  // reveal Chunklet only after the door finishes its swing
  setTimeout(() => {
    chunkletContainer.classList.add('active');
    chunkletContainer.classList.add('trotting');

    // fade the swell as he arrives
    fadeOut(swellSnd, 900);

    // then show bubble after trot completes
    setTimeout(() => {
      outputContainer.classList.add('active');
    }, TROT_MS);
  }, DOOR_MS);
}

function closeDoor(){
  if(!doorOpen) return;
  doorOpen = false;

  // stop swell immediately
  try{ swellSnd.pause(); swellSnd.currentTime = 0; }catch(_){}

  // Hide everything
  chunkletContainer.classList.remove('active', 'trotting');
  outputContainer.classList.remove('active');

  // Close door after chunklet disappears
  setTimeout(() => {
    doorTrigger.classList.remove('door-open');
    busy = false;
  }, 500);
}

/* main */
const FETCH_URL = ENDPOINT + QUERY;

async function summon(){
  if(busy || frozen) return;

  /* click fx */
  try{ 
    clickSnd.currentTime = 0; 
    clickSnd.play(); 
  }catch(_){}

  busy = true;
  stopAudio();

  /* Open door and show chunklet */
  openDoor();

  /* clear previous */
  typed.textContent='';
  const oldTag = output.querySelector('.work-tag'); 
  if(oldTag) oldTag.remove();

  try{
    // Wait for door open + trot animation
    await new Promise(resolve => setTimeout(resolve, DOOR_MS + TROT_MS + 200));

    const res = await fetch(FETCH_URL, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const work = data.work || null;
    const author = data.author || null;
    const text = sanitize(data.text);

    typeOut(text, async ()=>{
      const onEnd = ()=>{
        showWork(work, author);
        if(!frozen){
          setTimeout(() => { closeDoor(); }, 3000);
        }
      };
      
      if(data.audioBase64){
        await playAudio(data.audioBase64, onEnd);
      }else{
        startMouth();
        const approx = Math.min(7, Math.max(2.2, text.length/16));
        setTimeout(()=>{ stopMouth(); onEnd(); }, (approx+0.2)*1000);
      }
    });

  }catch(e){
    console.error(e);
    typeOut('A shy packet tripped. Try again.');
    if(!frozen){
      setTimeout(() => { closeDoor(); }, 2000);
    } else {
      busy=false;
    }
  }
}

/* Controls */
function setFrozen(v){
  frozen = !!v;
  freezeBtn.setAttribute('aria-pressed', frozen ? 'true' : 'false');
  freezeBtn.textContent = frozen ? 'Unfreeze' : 'Freeze';
}
freezeBtn.addEventListener('click', ()=>{
  setFrozen(!frozen);
  if(!frozen && doorOpen){
    setTimeout(()=>{ if(!frozen) closeDoor(); }, 800);
  }
});

replayBtn.addEventListener('click', ()=>{
  if(audioEl && audioEl.src){
    try{ audioEl.currentTime = 0; audioEl.play(); }catch(_){}
  }else if(currentSource && audioCtx){
    // if buffer source ended, just resummon (unless frozen/busy)
    if(!busy && !frozen) summon();
  }
});

copyBtn.addEventListener('click', async ()=>{
  const text = typed.textContent || '';
  try{
    await navigator.clipboard.writeText(text);
    copyBtn.textContent = 'Copied!';
    setTimeout(()=> copyBtn.textContent='Copy', 900);
  }catch(_){
    copyBtn.textContent = 'Oops';
    setTimeout(()=> copyBtn.textContent='Copy', 900);
  }
});

/* Triggers */
doorTrigger.addEventListener('click', summon);
document.addEventListener('keydown', e=>{
  if(e.key===' '||e.key==='Enter'){ summon(); }
  if(e.key==='f' || e.key==='F'){ setFrozen(!frozen); }
  if(e.key==='r' || e.key==='R'){ replayBtn.click(); }
  if(e.key==='c' || e.key==='C'){ copyBtn.click(); }
});
</script>
</body>
</html>
