<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>chubby chunklet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons -->
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="apple-touch-icon" href="favicon.png" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <!-- Emilys Candy for the quote, Rubik for UI -->
  <link href="https://fonts.googleapis.com/css2?family=Emilys+Candy&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --endpoint: https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet;

      /* Chunklet sprite / mouth calibration */
      --figure-scale:1.15;
      --mouth-top:39%;
      --mouth-left:49%;
      --mouth-w:20px;
      --mouth-h:20px;
      --mouth-scale-0:.05;

      --char-ms:18;

      /* Door anchors (NORMALISED to bg) */
      --door-x:0.472; --door-y:0.579; --door-w:0.099; --door-h:0.248;

      /* Bubble layout */
      --output-top-fallback:8vmin;
      --bubble-gap:18px;
      --tail-x:50%;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      font-family:Rubik,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:#000;color:#fff;-webkit-font-smoothing:antialiased;
      overflow:hidden;height:100%;width:100%;
    }

    /* ===== Scene ===== */
    .scene-container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#4a7ba7;}
    .scene-bg{width:100%;height:100%;position:relative;display:flex;align-items:center;justify-content:center;perspective:900px;}
    .scene-bg img{width:100%;height:100%;object-fit:cover;display:block;user-select:none;-webkit-user-drag:none;}

    /* ===== Door ===== */
    .door-container{
      position:absolute;left:50%;top:52%;width:140px;height:180px;
      transform:translate(-50%,-50%);cursor:pointer;z-index:50;
    }
    .door-left,.door-right{
      position:absolute;width:50%;height:100%;
      background:#3d2418;border:3px solid #2d1810;
      transition:transform .8s cubic-bezier(.68,-0.55,.265,1.55);
      box-shadow:inset 0 0 20px rgba(0,0,0,.4),0 0 10px rgba(0,0,0,.8);
      backface-visibility:hidden;transform-style:preserve-3d;
    }
    .door-left{left:0;transform-origin:left center;border-right:2px solid #1a0e08;}
    .door-right{right:0;transform-origin:right center;border-left:2px solid #1a0e08;}
    .door-panel{position:absolute;background:#2d1810;border:2px solid #1a0e08;
      box-shadow:inset 2px 2px 4px rgba(0,0,0,.4),inset -1px -1px 2px rgba(61,36,24,.3);}
    .door-left .panel-top,.door-right .panel-top{width:65%;height:22%;top:15%;}
    .door-left .panel-mid,.door-right .panel-mid{width:65%;height:22%;top:41%;}
    .door-left .panel-bottom,.door-right .panel-bottom{width:65%;height:22%;top:67%;}
    .door-left .panel-top,.door-left .panel-mid,.door-left .panel-bottom{left:17.5%;}
    .door-right .panel-top,.door-right .panel-mid,.door-right .panel-bottom{right:17.5%;}
    .door-open .door-left{transform:rotateY(85deg);}
    .door-open .door-right{transform:rotateY(-85deg);}

    /* ===== Chunklet ===== */
    .chunklet-container{position:absolute;transform:translate(-50%,-30px);opacity:0;transition:opacity .3s;z-index:60;pointer-events:none;}
    .chunklet-container.active{opacity:1;}
    .chunklet-wrap{position:relative;width:calc(100px*var(--figure-scale));height:calc(130px*var(--figure-scale));display:flex;align-items:flex-end;justify-content:center;}
    .chunklet-img{width:calc(90px*var(--figure-scale));max-width:100%;user-select:none;-webkit-user-drag:none;filter:drop-shadow(0 8px 16px rgba(0,0,0,.6));image-rendering:-webkit-optimize-contrast;}
    .ground-shadow{position:absolute;left:50%;bottom:-2px;width:88px;height:18px;transform:translateX(-50%) scale(.6);
      background:radial-gradient(ellipse at center,rgba(0,0,0,.45) 0%,rgba(0,0,0,.25) 40%,rgba(0,0,0,0) 70%);filter:blur(2px);opacity:0;}

    .mouth-overlay{position:absolute;top:var(--mouth-top);left:var(--mouth-left);width:var(--mouth-w);height:var(--mouth-h);transform:translate(-50%,-50%);display:flex;align-items:center;justify-content:center;pointer-events:none;}
    .mouth-overlay svg{width:100%;height:100%}
    #mouth{transform-origin:50% 50%;transform:scale(1,var(--mouth-scale-0))}

    /* ===== Speech bubble ===== */
    .output-container{position:fixed;left:50%;transform:translateX(-50%);width:76%;max-width:860px;min-width:280px;z-index:40;pointer-events:none;opacity:0;transition:opacity .5s;top:var(--output-top-fallback);}
    .output-container.active{opacity:1;}

    .bubble-wrap{position:relative;}
    .speech-bubble{background:#fff;border:6px solid #000;border-radius:38px;padding:26px 32px;color:#111;
      box-shadow:0 6px 0 #000,0 14px 30px rgba(0,0,0,.35);opacity:0; /* ⇠ UPDATED  hide until typing starts */
      transition:opacity .25s ease;
    }
    .bubble-tail{position:absolute;bottom:-2px;left:var(--tail-x);transform:translate(-50%,100%);width:44px;height:28px;overflow:visible;pointer-events:none;opacity:0;transition:opacity .25s ease;}

    /* ⇠ UPDATED  Emilys Candy restored */
    .output{font-family:"Emilys Candy",Rubik,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      text-transform:uppercase;font-weight:400;font-size:clamp(22px,2.4vw,36px);line-height:1.04;letter-spacing:-.06em;color:#111;text-align:center;margin:0;white-space:pre-wrap;}
    .cursor{display:inline-block;width:.5ch;height:1.05em;background:#111;vertical-align:text-bottom;animation:blink 1s steps(1,end) infinite;border-radius:2px;}
    @keyframes blink{0%,55%{opacity:1}56%,100%{opacity:0}}
    .typing .cursor{animation:none}

    .output .work-tag{opacity:.95;text-transform:uppercase;margin-left:.6em;font-size:.65em;letter-spacing:-.04em;color:#333;display:block;margin-top:10px;}

    /* ===== Animations ===== */
    @keyframes emergePop{0%{transform:translate(-50%,-60px) scale(.86,.92) rotate(-3deg);opacity:0;filter:brightness(.85);}40%{transform:translate(-50%,-28px) scale(1.06,.94) rotate(-2deg);opacity:1;}60%{transform:translate(-50%,-18px) scale(.96,1.04) rotate(2deg);}100%{transform:translate(-50%,-12px) scale(1) rotate(0deg);}}
    @keyframes waddleDown{0%{transform:translate(-50%,-12px)}10%{transform:translate(-50%,0) rotate(-3deg)}20%{transform:translate(-50%,10px) rotate(3deg)}30%{transform:translate(-50%,20px) rotate(-3deg)}40%{transform:translate(-50%,30px) rotate(3deg)}55%{transform:translate(-50%,45px) rotate(-2deg)}70%{transform:translate(-50%,58px) rotate(2deg)}85%{transform:translate(-50%,66px) rotate(-1deg) scale(1.02,.98)}100%{transform:translate(-50%,70px)}}
    @keyframes shadowEmerge{0%{opacity:0;transform:translateX(-50%) scale(.4)}60%{opacity:.55;transform:translateX(-50%) scale(.75)}100%{opacity:.65;transform:translateX(-50%) scale(.85)}}
    @keyframes shadowWaddle{0%{opacity:.65;transform:translateX(-50%) scale(.85)}25%{opacity:.70;transform:translateX(-50%) scale(.95)}50%{opacity:.60;transform:translateX(-50%) scale(.88)}75%{opacity:.72;transform:translateX(-50%) scale(1)}100%{opacity:.68;transform:translateX(-50%) scale(1.05)}}

    .chunklet-container.emerge{animation:emergePop .7s cubic-bezier(.22,1,.36,1) forwards;}
    .chunklet-container.waddle{animation:waddleDown 2.4s cubic-bezier(.22,1,.36,1) forwards;}
    .chunklet-container.emerge .ground-shadow{animation:shadowEmerge .7s ease-out forwards;}
    .chunklet-container.waddle .ground-shadow{animation:shadowWaddle 2.4s ease-out forwards;}

    @keyframes breathe{0%,100%{transform:translateY(0)}50%{transform:translateY(3px)}} /* ⇠ UPDATED  tiny inhale */

    /* Calibration HUD */
    .cal-hud{position:fixed;left:8px;bottom:8px;font:12px/1.3 Rubik,ui-monospace,Menlo,Consolas,monospace;background:rgba(0,0,0,.6);color:#0ff;padding:8px 10px;border:1px solid rgba(0,255,255,.35);border-radius:6px;pointer-events:none;opacity:0;transition:opacity .15s;white-space:pre;z-index:100;}
    .cal-hud.on{opacity:1;}

    @media(max-width:600px){
      .output-container{width:92%;}
      .output{font-size:clamp(18px,4.2vw,28px);}
      .speech-bubble{border-radius:30px;padding:20px 22px;}
    }
  </style>
</head>
<body>
  <audio id="clickSnd" src="click.mp3" preload="auto"></audio>

  <div class="scene-container">
    <div class="scene-bg">
      <img src="skullbones.png" alt="Scene background" />

      <!-- Door -->
      <div class="door-container" id="doorTrigger" role="button" tabindex="0" aria-label="Open the door">
        <div class="door-left">
          <div class="door-panel panel-top"></div>
          <div class="door-panel panel-mid"></div>
          <div class="door-panel panel-bottom"></div>
        </div>
        <div class="door-right">
          <div class="door-panel panel-top"></div>
          <div class="door-panel panel-mid"></div>
          <div class="door-panel panel-bottom"></div>
        </div>
      </div>

      <!-- Chunklet -->
      <div class="chunklet-container" id="chunkletContainer" aria-hidden="true">
        <div class="chunklet-wrap">
          <img src="littleboytalk.png" alt="Chubby Chunklet" class="chunklet-img" />
          <div class="mouth-overlay">
            <svg viewBox="0 0 100 100" aria-hidden="true">
              <ellipse id="mouth" cx="50" cy="50" rx="26" ry="24" fill="#111"/>
            </svg>
          </div>
          <div class="ground-shadow"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Speech bubble output -->
  <div class="output-container" id="outputContainer" aria-live="polite">
    <div class="bubble-wrap">
      <div class="speech-bubble" id="bubble">
        <div class="output" id="output">
          <span id="typed"></span><span id="cursor" class="cursor"></span>
        </div>
      </div>
      <svg class="bubble-tail" id="bubbleTail" viewBox="0 0 44 28" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
        <path d="M4,2 C14,20 30,20 40,2" fill="#fff" stroke="#000" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <div class="cal-hud" id="calHud"></div>

  <script>
    /* --- (all JS identical to previous version except: bubble visibility, breathing loop, and closeDoor timing) --- */

    const css = getComputedStyle(document.documentElement);
    const ENDPOINT = (css.getPropertyValue('--endpoint')||'').trim()||'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';
    const QUERY='?style=canon&modern=0&accent=scottish';
    const CHAR_MS=parseInt(css.getPropertyValue('--char-ms'),10)||20;
    const DOOR_SWING_MS=800,EMERGE_MS=700,WADDLE_MS=2400;

    /* DOM refs */
    const doorTrigger=document.getElementById('doorTrigger');
    const chunkletContainer=document.getElementById('chunkletContainer');
    const outputContainer=document.getElementById('outputContainer');
    const bubble=document.getElementById('bubble');
    const bubbleTail=document.getElementById('bubbleTail');
    const typed=document.getElementById('typed');
    const cursor=document.getElementById('cursor');
    const mouth=document.getElementById('mouth');
    const output=document.getElementById('output');
    const clickSnd=document.getElementById('clickSnd');
    const bgImg=document.querySelector('.scene-bg img');
    const host=document.querySelector('.scene-bg');
    const isIOS=/iP(hone|od|ad)|Macintosh.*Mobile/.test(navigator.userAgent);

    /* state */
    let busy=false,doorOpen=false,breatheTimer=null;
    let audioCtx,currentSource,audioEl,mediaSource,analyser,timeData,raf,animating=false,tagPlaying=false,currentObjectURL=null,iosAudioInitialized=false;

    /* helpers already in previous code ... (omitted comments) */

    function startBreathe(){
      if(breatheTimer)return;
      chunkletContainer.style.animation='breathe 1.6s ease-in-out infinite';
      breatheTimer=setInterval(()=>{setLevel(level?0:2);},400);
    }
    function stopBreathe(){
      if(!breatheTimer)return;
      clearInterval(breatheTimer);breatheTimer=null;
      chunkletContainer.style.animation='';
      setClosed();
    }

    /* Door sequence */
    function openDoor(){
      if(doorOpen)return;
      positionDoorAndChunklet();
      doorOpen=true;doorTrigger.classList.add('door-open');

      setTimeout(()=>{
        chunkletContainer.classList.add('active','emerge');
        setTimeout(()=>{
          chunkletContainer.classList.remove('emerge');
          chunkletContainer.classList.add('waddle');
          setTimeout(()=>{
            outputContainer.classList.add('active');
            bubble.style.opacity=0;bubbleTail.style.opacity=0; /* hide bubble for now */
            startBreathe();                                    /* ⇠ UPDATED */
            placeBubble();
          },WADDLE_MS);
        },EMERGE_MS);
      },DOOR_SWING_MS);
    }

    function closeDoor(){
      stopBreathe();stopAudio();
      chunkletContainer.classList.remove('active','waddle');
      outputContainer.classList.remove('active');
      bubble.style.opacity=0;bubbleTail.style.opacity=0;
      setTimeout(()=>{doorTrigger.classList.remove('door-open');doorOpen=false;busy=false;},500);
    }

    /*   — (typeOut, playAudio, etc. remain the same except final closeDoor happens in onEnd)   */
    function typeOut(text,done){
      typed.textContent='';output.classList.add('typing');
      bubble.style.opacity=1;bubbleTail.style.opacity=1; /* ⇠ UPDATED  reveal bubble when typing starts */
      stopBreathe();                                     /* ⇠ UPDATED */
      (function loop(i=0){
        typed.textContent=text.slice(0,i);placeBubble();
        if(i<text.length){setTimeout(()=>loop(i+1),CHAR_MS+((i%7)?0:Math.random()*10));}
        else{output.classList.remove('typing');placeBubble();done&&done();}
      })();
    }

    function summon(){
      if(busy)return;
      try{clickSnd.currentTime=0;clickSnd.play();}catch(_){}
      busy=true;stopAudio();openDoor();
      typed.textContent='';const old=document.querySelector('#output .work-tag');if(old)old.remove();

      (async()=>{
        try{
          await new Promise(r=>setTimeout(r,DOOR_SWING_MS+EMERGE_MS+WADDLE_MS));
          const res=await fetch(ENDPOINT+QUERY,{cache:'no-store'});
          if(!res.ok)throw new Error('HTTP '+res.status);
          const data=await res.json();
          const work=data.work||null,author=data.author||null;
          const text=((data.text||'').trim().replace(/!+$/,'')||'')+( /[.?!]$/.test(data.text||'')?'':'.');

          typeOut(text,()=>{
            showWork(work,author);
            placeBubble();
          });

          const finish=()=>{closeDoor();};
          if(data.audioBase64){playAudio(data.audioBase64,finish);}
          else{
            startMouth();
            const ms=Math.max(2300,text.length*85);
            setTimeout(()=>{stopMouth();finish();},ms);
          }

        }catch(e){
          console.error(e);
          typeOut('A shy packet tripped. Try again.',()=>setTimeout(closeDoor,2000));
        }
      })();
    }

    doorTrigger.addEventListener('click',summon);
    doorTrigger.addEventListener('keydown',e=>{if(e.key===' '||e.key==='Enter'){e.preventDefault();summon();}});
    /* rest of JS (positioning, calibration HUD) identical to previous full file */

    /* => initial layout */
    function onReady(){
      positionDoorAndChunklet();
      setTimeout(positionDoorAndChunklet,50);
      setTimeout(positionDoorAndChunklet,250);
    }
    if(bgImg.complete)onReady();else bgImg.addEventListener('load',onReady);
    window.addEventListener('resize',positionDoorAndChunklet);
    window.addEventListener('orientationchange',positionDoorAndChunklet);
  </script>
</body>
</html>
