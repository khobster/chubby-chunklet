<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>chubby chunklet</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Icons -->
<link rel="icon" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Emilys+Candy&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root{
  /* Backend */
  --endpoint: https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet;

  /* Door anchors (verified) */
  --door-x: 0.472;
  --door-y: 0.579;
  --door-w: 0.099;
  --door-h: 0.248;

  /* Chunklet + mouth */
  --figure-scale:1.15;
  --mouth-top:39%;  --mouth-left:49%;
  --mouth-w:20px;   --mouth-h:20px;   --mouth-scale-0:.05;

  /* Typing */
  --char-ms:18;

  /* Bubble */
  --output-top-fallback: calc(env(safe-area-inset-top, 0px) + 8vmin);
  --bubble-gap:18px;
  --tail-x:50%;
}

*{box-sizing:border-box}
html,body{
  margin:0;height:100%;width:100%;overflow:hidden;
  background:#000;color:#fff;
  font-family:Rubik,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
}

/* ===== Scene ===== */
.scene-container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
.scene-bg{position:relative;display:flex;align-items:center;justify-content:center;width:100%;height:100%;perspective:900px}
.scene-bg img{width:100%;height:100%;object-fit:cover;object-position:center;user-select:none;-webkit-user-drag:none}

/* ===== Door ===== */
.door-container{position:absolute;left:50%;top:52%;width:140px;height:180px;transform:translate(-50%,-50%);cursor:pointer;z-index:50}
.door-left,.door-right{position:absolute;width:50%;height:100%;background:#3d2418;border:3px solid #2d1810;
  transition:transform .8s cubic-bezier(.68,-.55,.265,1.55);box-shadow:inset 0 0 20px rgba(0,0,0,.4),0 0 10px rgba(0,0,0,.8);
  backface-visibility:hidden;transform-style:preserve-3d}
.door-left{left:0;transform-origin:left center;border-right:2px solid #1a0e08}
.door-right{right:0;transform-origin:right center;border-left:2px solid #1a0e08}
.door-panel{position:absolute;background:#2d1810;border:2px solid #1a0e08;
  box-shadow:inset 2px 2px 4px rgba(0,0,0,.4),inset -1px -1px 2px rgba(61,36,24,.3)}
.door-left .panel-top,.door-right .panel-top,
.door-left .panel-mid,.door-right .panel-mid,
.door-left .panel-bottom,.door-right .panel-bottom{width:65%;height:22%}
.door-left .panel-top{top:15%;left:17.5%}.door-left .panel-mid{top:41%;left:17.5%}.door-left .panel-bottom{top:67%;left:17.5%}
.door-right .panel-top{top:15%;right:17.5%}.door-right .panel-mid{top:41%;right:17.5%}.door-right .panel-bottom{top:67%;right:17.5%}
.door-open .door-left{transform:rotateY(85deg)} .door-open .door-right{transform:rotateY(-85deg)}

/* ===== Chunklet ===== */
.chunklet-container{position:absolute;transform:translate(-50%,-30px);opacity:0;transition:opacity .3s;z-index:60;pointer-events:none}
.chunklet-container.active{opacity:1}
.chunklet-wrap{position:relative;width:calc(100px*var(--figure-scale));height:calc(130px*var(--figure-scale));display:flex;align-items:flex-end;justify-content:center}
.chunklet-img{width:calc(90px*var(--figure-scale));filter:drop-shadow(0 8px 16px rgba(0,0,0,.6))}
.ground-shadow{position:absolute;left:50%;bottom:-2px;width:88px;height:18px;transform:translateX(-50%) scale(.6);
  background:radial-gradient(ellipse at center,rgba(0,0,0,.45)0%,rgba(0,0,0,.25)40%,rgba(0,0,0,0)70%);filter:blur(2px);opacity:0}
.mouth-overlay{position:absolute;top:var(--mouth-top);left:var(--mouth-left);width:var(--mouth-w);height:var(--mouth-h);transform:translate(-50%,-50%)}
#mouth{transform-origin:50% 50%;transform:scale(1,var(--mouth-scale-0))}

/* ===== Bubble ===== */
.output-container{position:fixed;left:50%;transform:translateX(-50%);width:auto;max-width:90vw;
  opacity:0;transition:opacity .5s;pointer-events:none;top:var(--output-top-fallback);text-align:center;z-index:40}
.output-container.active{opacity:1}
.bubble-wrap{position:relative;display:inline-block}
.speech-bubble{background:#fff;border:6px solid #000;border-radius:32px;padding:18px 26px 18px 22px;
  box-shadow:0 6px 0 #000,0 14px 30px rgba(0,0,0,.35);color:#111;max-width:86vw}
.bubble-tail{position:absolute;bottom:-2px;left:var(--tail-x);transform:translate(-50%,100%);width:44px;height:28px;pointer-events:none}
.output{font-family:"Emilys Candy",Rubik,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  text-transform:uppercase;font-weight:400;font-size:clamp(22px,2.4vw,36px);line-height:1.04;
  letter-spacing:-.06em;word-spacing:-.04em;margin:0;white-space:pre-wrap;color:#111}
.cursor{display:inline-block;width:.5ch;height:1.05em;background:#111;vertical-align:text-bottom;border-radius:2px;
  animation:blink 1s steps(1,end) infinite}@keyframes blink{0%,55%{opacity:1}56%,100%{opacity:0}}
.output .work-tag{display:block;margin-top:10px;font-size:.72em;letter-spacing:-.06em;word-spacing:-.04em;color:#333;opacity:.95}
@media(max-width:600px){
  .output{font-size:clamp(18px,4.1vw,28px)}
  .output .work-tag{font-size:.85em}
  .speech-bubble{border-radius:28px;padding:14px 18px 14px 16px}
  .output-container{max-width:94vw}
}

/* ===== Animations ===== */
@keyframes emergePop{0%{transform:translate(-50%,-60px)scale(.86,.92)rotate(-3deg);opacity:0;filter:brightness(.85)}
 40%{transform:translate(-50%,-28px)scale(1.06,.94)rotate(-2deg);opacity:1}
 60%{transform:translate(-50%,-18px)scale(.96,1.04)rotate(2deg)}100%{transform:translate(-50%,-12px)}}
@keyframes waddleDown{0%{transform:translate(-50%,-12px)}10%{transform:translate(-50%,0)rotate(-3deg)}
 20%{transform:translate(-50%,10px)rotate(3deg)}30%{transform:translate(-50%,20px)rotate(-3deg)}
 40%{transform:translate(-50%,30px)rotate(3deg)}55%{transform:translate(-50%,45px)rotate(-2deg)}
 70%{transform:translate(-50%,58px)rotate(2deg)}85%{transform:translate(-50%,66px)rotate(-1deg)scale(1.02,.98)}
 100%{transform:translate(-50%,70px)}}
@keyframes shadowEmerge{0%{opacity:0;transform:translateX(-50%)scale(.4)}
 60%{opacity:.55;transform:translateX(-50%)scale(.75)}100%{opacity:.65;transform:translateX(-50%)scale(.85)}}
@keyframes shadowWaddle{0%{opacity:.65;transform:translateX(-50%)scale(.85)}
 25%{opacity:.7;transform:translateX(-50%)scale(.95)}50%{opacity:.6;transform:translateX(-50%)scale(.88)}
 75%{opacity:.72;transform:translateX(-50%)scale(1)}100%{opacity:.68;transform:translateX(-50%)scale(1.05)}}
.chunklet-container.emerge{animation:emergePop .7s cubic-bezier(.22,1,.36,1) forwards}
.chunklet-container.waddle{animation:waddleDown 2.4s cubic-bezier(.22,1,.36,1) forwards}
.chunklet-container.emerge .ground-shadow{animation:shadowEmerge .7s ease-out forwards}
.chunklet-container.waddle .ground-shadow{animation:shadowWaddle 2.4s ease-out forwards}
</style>
</head>

<body>
<!-- click sfx -->
<audio id="clickSnd" src="click.mp3" preload="auto"></audio>

<div class="scene-container">
  <div class="scene-bg">
    <img src="skullbones.png" alt="Temple scenery">

    <!-- Door -->
    <div class="door-container" id="doorTrigger" tabindex="0" role="button" aria-label="Open the door">
      <div class="door-left">
        <div class="door-panel panel-top"></div>
        <div class="door-panel panel-mid"></div>
        <div class="door-panel panel-bottom"></div>
      </div>
      <div class="door-right">
        <div class="door-panel panel-top"></div>
        <div class="door-panel panel-mid"></div>
        <div class="door-panel panel-bottom"></div>
      </div>
    </div>

    <!-- Chunklet -->
    <div class="chunklet-container" id="chunkletContainer" aria-hidden="true">
      <div class="chunklet-wrap">
        <img src="littleboytalk.png" alt="Chubby Chunklet" class="chunklet-img">
        <div class="mouth-overlay">
          <svg viewBox="0 0 100 100" aria-hidden="true"><ellipse id="mouth" cx="50" cy="50" rx="26" ry="24" fill="#111"/></svg>
        </div>
        <div class="ground-shadow"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bubble -->
<div class="output-container" id="outputContainer" aria-live="polite">
  <div class="bubble-wrap">
    <div class="speech-bubble"><div class="output" id="output"><span id="typed"></span><span id="cursor" class="cursor"></span></div></div>
    <svg class="bubble-tail" id="bubbleTail" viewBox="0 0 44 28" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
      <path d="M4,2 C14,20 30,20 40,2" fill="#fff" stroke="#000" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const css=getComputedStyle(document.documentElement);
const ENDPOINT=(css.getPropertyValue('--endpoint')||'').trim()||'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';
const QUERY='?style=canon&modern=0&accent=scottish';
const CHAR_MS=parseInt(css.getPropertyValue('--char-ms'),10)||20;

/* ===== DOM ===== */
const host=document.querySelector('.scene-bg'),bgImg=document.querySelector('.scene-bg img');
const door=document.getElementById('doorTrigger'),guy=document.getElementById('chunkletContainer');
const outWrap=document.getElementById('outputContainer'),typed=document.getElementById('typed'),cursor=document.getElementById('cursor');
const mouth=document.getElementById('mouth'),click=document.getElementById('clickSnd');

/* ===== Door anchors ===== */
function DOOR(){return{
  x:parseFloat(css.getPropertyValue('--door-x'))||.5,
  y:parseFloat(css.getPropertyValue('--door-y'))||.55,
  w:parseFloat(css.getPropertyValue('--door-w'))||.1,
  h:parseFloat(css.getPropertyValue('--door-h'))||.25};}

function position(){
  const r=host.getBoundingClientRect(),nw=bgImg.naturalWidth,nh=bgImg.naturalHeight;
  const s=nw&&nh?Math.max(r.width/nw,r.height/nh):1,dispW=(nw||r.width)*s,dispH=(nh||r.height)*s;
  const offX=(r.width-dispW)/2,offY=(r.height-dispH)/2,d=DOOR();
  const cx=r.left+offX+dispW*d.x,cy=r.top+offY+dispH*d.y,dw=dispW*d.w,dh=dispH*d.h;
  Object.assign(door.style,{left:cx-r.left+'px',top:cy-r.top+'px',width:dw+'px',height:dh+'px'});
  Object.assign(guy.style,{left:cx-r.left+'px',top:cy+dh*.35-r.top+'px'});
  placeBubble();
}
function placeBubble(){
  const card=outWrap.getBoundingClientRect(),g=guy.getBoundingClientRect();
  if(!(card.width&&g.width))return;
  const gap=parseFloat(css.getPropertyValue('--bubble-gap')),safe=parseFloat(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-top,0px)'));
  outWrap.style.top=Math.max(8+safe,g.top-gap-card.height)+'px';
  const tailPct=Math.max(8,Math.min(92,((g.left+g.width/2)-card.left)/card.width*100));
  outWrap.style.setProperty('--tail-x',tailPct+'%');
}
if(bgImg.complete)ready();else bgImg.addEventListener('load',ready);
function ready(){position();setTimeout(position,50);setTimeout(position,250);}
window.addEventListener('resize',position);window.addEventListener('orientationchange',position);
new ResizeObserver(()=>placeBubble()).observe(outWrap);

/* ===== Typing ===== */
function typeOut(txt,done){
  typed.textContent='';cursor.style.display='inline-block';
  (function loop(i=0){
    typed.textContent=txt.slice(0,i);placeBubble();
    if(i<txt.length)setTimeout(()=>loop(i+1),CHAR_MS+((i%7)?0:Math.random()*10));
    else{cursor.style.display='none';placeBubble();done&&done();}
  })();
}

/* ===== Mouth anim ===== */
const SY=[.07,.55,1.1,1.7,2.3],SX=[1,1.01,1.02,1.02,1.03],THU=[.03,.06,.1,.16],THD=THU.map(t=>t-.018);
let audioCtx,analyser,timeBuf,src,raf,level=0,last=0;
function ensureCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();}
function ensureAnalyser(){ensureCtx();if(!analyser){analyser=audioCtx.createAnalyser();analyser.fftSize=256;timeBuf=new Float32Array(analyser.fftSize);}}
function setL(n){n=Math.max(0,Math.min(4,n));if(n===level)return;level=n;mouth.style.transform=`scale(${SX[n]},${SY[n]})`;last=performance.now();}
function startMouth(){if(raf)return;raf=requestAnimationFrame(step);}
function stopMouth(){cancelAnimationFrame(raf);raf=null;setL(0);}
function step(){
  raf=requestAnimationFrame(step);
  if(src){
    analyser.getFloatTimeDomainData(timeBuf);let s=0;for(const v of timeBuf)s+=v*v;const v=Math.sqrt(s/timeBuf.length);
    let t=level;while(t<4&&v>=THU[t])t++;while(t>0&&v<THD[t-1])t--;if(t<level&&(performance.now()-last)<20)t=level;setL(t);
  }else{const p=((performance.now()/1000*13)|0)%4,r=Math.random();setL(p===0?0:p===1?(r<.7?1:2):p===2?(r<.6?2:3):(r<.5?3:4));}
}

/* ===== Audio ===== */
async function speak(b64,done){
  try{
    ensureAnalyser();
    const bin=Uint8Array.from(atob(b64.split(',')[1]),c=>c.charCodeAt(0)),buf=await audioCtx.decodeAudioData(bin.buffer);
    src=audioCtx.createBufferSource();src.buffer=buf;src.connect(analyser);analyser.connect(audioCtx.destination);
    src.start();startMouth();src.onended=()=>{src=null;stopMouth();done();};
  }catch(e){console.warn(e);done();}
}

/* ===== Door choreography ===== */
let open=false,busy=false;
function openDoor(){
  if(open)return;open=true;door.classList.add('door-open');
  setTimeout(()=>{guy.classList.add('active','emerge');
    setTimeout(()=>{guy.classList.remove('emerge');guy.classList.add('waddle');
      setTimeout(()=>{outWrap.classList.add('active');placeBubble();},2400);
    },700);
  },800);
}
function closeDoor(){if(!open)return;open=false;guy.classList.remove('active','waddle');outWrap.classList.remove('active');
  setTimeout(()=>{door.classList.remove('door-open');busy=false;},500);}

/* ===== Main loop ===== */
async function summon(){
  if(busy)return;busy=true;try{click.currentTime=0;click.play();}catch(_){}
  openDoor();typed.textContent='';document.querySelectorAll('.work-tag').forEach(n=>n.remove());

  try{
    await new Promise(r=>setTimeout(r,800+700+2400));
    const j=await fetch(ENDPOINT+QUERY,{cache:'no-store'}).then(r=>r.json());
    const txt=/[.?!]$/.test(j.text.trim())?j.text.trim():j.text.trim()+'.';
    typeOut(txt,()=>{const done=()=>{
        if(j.work||j.author){const sp=document.createElement('span');sp.className='work-tag';sp.textContent='— '+[j.work,j.author].filter(Boolean).join(' · ');
          document.getElementById('output').appendChild(sp);placeBubble();}
        setTimeout(closeDoor,3000);
    };
      if(j.audioBase64)speak(j.audioBase64,done);else{startMouth();setTimeout(()=>{stopMouth();done();},Math.max(2200,txt.length*120));}
    });
  }catch(e){console.error(e);typeOut('A shy packet tripped. Try again.',()=>setTimeout(closeDoor,2000));}
}
door.addEventListener('click',summon);
door.addEventListener('keydown',e=>{if(e.key===' '||e.key==='Enter'){e.preventDefault();summon();}});
position();
</script>
</body>
</html>
