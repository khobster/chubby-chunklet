<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chubby Chunklet</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root {
  --bg:#eef0f3;
  --accent:#213247;
  --accent-hi:#2f4b68;
  --face:#ffd9af;
  --body:#ffd54c;
  --body-shadow:#d49a25;
  --base:#f1f1f1;
  --shadow:rgba(0,0,0,0.22);
  --fg:#1e2730;
}

*{box-sizing:border-box;}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:var(--bg);
  color:var(--fg);
  -webkit-font-smoothing:antialiased;
}
h1{
  text-align:center;
  margin:34px 0 6px;
  font-size:clamp(2.2rem,6vw,3rem);
}
p.sub{
  text-align:center;
  margin:0 0 32px;
  color:#4a5762;
}

main.stage{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:32px;
  padding-bottom:80px;
}

.figure-wrap{
  position:relative;
  width:240px;
  height:280px;
  display:flex;
  align-items:center;
  justify-content:center;
}

.chunklet{
  position:relative;
  width:170px;
  height:260px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  filter:drop-shadow(0 14px 30px -10px var(--shadow)) drop-shadow(0 5px 14px -6px rgba(0,0,0,0.3));
  animation:float 6s ease-in-out infinite;
}

@keyframes float {
  0%,100% { transform:translateY(0); }
  50% { transform:translateY(-6px); }
}

.head{
  position:relative;
  margin-top:6px;
  width:150px;
  height:150px;
  background:radial-gradient(circle at 40% 28%, #ffe9ce, var(--face) 60%);
  border-radius:50%;
  box-shadow:inset 0 -10px 18px -12px rgba(0,0,0,0.25);
  display:flex;
  align-items:center;
  justify-content:center;
}

.face-features{
  position:absolute;
  top:45%;
  left:50%;
  width:70px;
  height:55px;
  transform:translate(-50%,-50%);
}

.eye{
  position:absolute;
  top:8px;
  width:16px;
  height:16px;
  background:#111;
  border-radius:50%;
  animation:blink 5.5s linear infinite;
}
.eye.left{ left:0; }
.eye.right{ right:0; }

.eye .spark{
  position:absolute;
  top:3px;
  left:4px;
  width:5px;
  height:5px;
  background:#fff;
  border-radius:50%;
  opacity:.85;
}

@keyframes blink {
  0%,92%,100% { transform:scaleY(1); }
  95% { transform:scaleY(.1); }
}

.swirl{
  position:absolute;
  top:-14px;
  left:50%;
  width:34px;
  height:34px;
  transform:translateX(-50%);
  pointer-events:none;
}
.swirl svg{
  width:100%; height:100%;
  stroke:#111;
  stroke-width:4;
  fill:none;
  stroke-linecap:round;
  stroke-linejoin:round;
}

.mouth{
  --open:0;
  position:absolute;
  left:50%;
  bottom:0;
  transform:translate(-50%, 0);
  width:42px;
  height:42px;
  display:flex;
  align-items:center;
  justify-content:center;
  /* Black oval that scales vertically for speech */
}
.mouth .oval{
  width:42px;
  height:42px;
  background:#111;
  border-radius:50%;
  transform:scaleY(var(--open));
  transform-origin:center center;
  transition:transform 0.07s linear;
  box-shadow:0 0 0 4px #221812 inset;
}

.body{
  margin-top:-18px;
  width:160px;
  height:150px;
  background:linear-gradient(180deg,var(--body),var(--body-shadow));
  border-radius:46% 46% 40% 40% / 58% 58% 38% 38%;
  position:relative;
  box-shadow:inset 0 -18px 34px -20px rgba(0,0,0,0.5);
}

.base{
  position:relative;
  margin-top:-38px;
  width:150px;
  height:70px;
  background:linear-gradient(180deg,#fafafa,#dadada);
  border-radius:60% 60% 45% 45% / 70% 70% 35% 35%;
  box-shadow: inset 0 -12px 24px -18px rgba(0,0,0,0.55);
}

button.trigger{
  font-size:1.05rem;
  background:var(--accent);
  color:#fff;
  padding:18px 56px;
  border:none;
  border-radius:44px;
  font-weight:600;
  letter-spacing:.5px;
  cursor:pointer;
  box-shadow:0 10px 24px -10px var(--shadow),0 3px 8px -5px rgba(0,0,0,0.25);
  transition:background .25s ease, transform .2s ease;
}
button.trigger:hover:not([disabled]){ background:var(--accent-hi); transform:translateY(-2px);}
button.trigger:active:not([disabled]){ transform:translateY(1px);}
button.trigger[disabled]{ opacity:.55; cursor:progress; }

.output{
  width:min(760px,90%);
  background:#fff;
  margin-top:14px;
  padding:20px 26px;
  border-radius:18px;
  font-size:1.15rem;
  line-height:1.45;
  box-shadow:0 8px 18px -8px var(--shadow);
  min-height:72px;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  position:relative;
}
.output.fade{ animation:fade .4s ease; }
@keyframes fade {
  from{opacity:0; transform:translateY(6px);}
  to{opacity:1; transform:translateY(0);}
}

.status{
  text-align:center;
  margin-top:10px;
  font-size:.82rem;
  font-weight:500;
  color:#c05724;
  min-height:1.1em;
}

.loading-bar{
  position:absolute;
  left:0; bottom:0;
  width:100%; height:4px;
  background:linear-gradient(90deg,#ffb347,#ff8847,#ffb347);
  background-size:200% 100%;
  animation:load 1s linear infinite;
  border-radius:0 0 18px 18px;
}
.hidden{display:none!important;}
@keyframes load {
  0%{background-position:0 0;}
  100%{background-position:-200% 0;}
}

footer{
  margin-top:60px;
  text-align:center;
  font-size:.7rem;
  letter-spacing:.4px;
  color:#66727c;
  padding-bottom:40px;
}

@media (max-width:600px){
  .figure-wrap{ width:200px; height:250px; }
  .head{ width:130px; height:130px; }
  .mouth .oval{ width:36px; height:36px; }
  .body{ width:140px; height:130px; }
  .base{ width:130px; height:64px; }
}
</style>
</head>
<body>
  <h1>Chubby Chunklet</h1>
  <p class="sub">He just *says things*. Pull the line (or press space) to hear him.</p>

  <main class="stage">
    <div class="figure-wrap">
      <div class="chunklet" id="chunklet">
        <div class="head">
          <div class="swirl">
            <!-- Simple swirl hair -->
            <svg viewBox="0 0 100 100">
              <path d="M50 70c14 0 22-13 16-24-5-10-19-10-24-1-4 8 1 14 7 15 8 1 13-6 11-12" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="face-features">
            <div class="eye left"><div class="spark"></div></div>
            <div class="eye right"><div class="spark"></div></div>
            <div class="mouth" id="mouth">
              <div class="oval"></div>
            </div>
          </div>
        </div>
        <div class="body"></div>
        <div class="base"></div>
      </div>
    </div>

    <button class="trigger" id="talkBtn">PULL STRING</button>

    <div class="output" id="output"><span id="line">Chunklet is idle…</span>
      <div id="loader" class="loading-bar hidden"></div>
    </div>
    <div class="status" id="status"></div>
  </main>

  <footer>Chubby Chunklet • playful TTS & mouth animation demo.</footer>

<script>
/* ================= CONFIG =================== */
const ENDPOINT = 'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet
'; // <-- REPLACE with your API Gateway endpoint

/* =============== ELEMENTS =================== */
const talkBtn    = document.getElementById('talkBtn');
const lineSpan   = document.getElementById('line');
const statusEl   = document.getElementById('status');
const loader     = document.getElementById('loader');
const outputBox  = document.getElementById('output');
const mouth      = document.getElementById('mouth').querySelector('.oval');

/* =============== STATE ====================== */
let busy=false;
let audio=null;
let timings=null;
let rafId=null;
let fallbackStart=0;

/* =============== HELPERS ==================== */
function setBusy(on){
  busy=on;
  talkBtn.disabled=on;
  loader.classList.toggle('hidden', !on);
  if(on) statusEl.textContent='';
}

function cancelAnim(){
  if(rafId) cancelAnimationFrame(rafId);
  rafId=null;
  mouth.style.setProperty('--open','0');
}

function applyLine(text){
  lineSpan.textContent=text;
  outputBox.classList.remove('fade');
  void outputBox.offsetWidth;
  outputBox.classList.add('fade');
}

function animateMouthFrame(ts){
  if(!timings){ mouth.style.setProperty('--open','0'); return;}
  let t;
  if(audio){
    t = audio.currentTime;
  } else {
    t = (performance.now()-fallbackStart)/1000;
  }
  // Find phoneme (linear okay)
  let openAmt=0.15;
  for(const p of timings.phonemes){
    if(t>=p.start && t<p.end){
      if(/[aeiou]/i.test(p.token)){
        // Scale vowel openness by length a bit
        const span = p.end - p.start;
        // Smooth ramp
        const local = (t - p.start)/span;
        const env = local<0.25 ? local/0.25 :
                    local>0.75 ? (1-(local-0.75)/0.25) : 1;
        openAmt = 0.25 + Math.min(1, span*3)*0.55*env;
      } else {
        openAmt = 0.15;
      }
      break;
    }
  }
  mouth.style.setProperty('--open', openAmt.toFixed(3));
  if(audio ? !audio.ended : t < (timings.totalDuration||0)){
    rafId = requestAnimationFrame(animateMouthFrame);
  } else {
    mouth.style.setProperty('--open','0');
  }
}

function startMouth(){
  cancelAnim();
  rafId = requestAnimationFrame(animateMouthFrame);
}

function networkError(e){
  console.error(e);
  lineSpan.textContent="Chunklet coughs out static. Try again.";
  statusEl.textContent="Temporary hiccup.";
}

/* =============== FETCH ====================== */
async function pullLine(){
  if(busy) return;
  setBusy(true);
  cancelAnim();
  try{
    const r = await fetch(ENDPOINT);
    if(!r.ok) throw new Error(r.status);
    const data = await r.json();
    applyLine(data.text);
    timings = data.timings;
    if(data.audioBase64){
      audio = new Audio('data:audio/'+(data.audioFormat||'mp3')+';base64,'+data.audioBase64);
      audio.oncanplay = () => {
        audio.play().catch(()=>{});
        startMouth();
      };
      audio.onended = () => {
        mouth.style.setProperty('--open','0');
      };
    }else{
      audio=null;
      fallbackStart=performance.now();
      startMouth();
    }
  }catch(e){
    networkError(e);
  }finally{
    setBusy(false);
  }
}

/* =============== EVENTS ===================== */
talkBtn.addEventListener('click', pullLine);
window.addEventListener('keydown', e=>{
  if(e.code==='Space'){ e.preventDefault(); pullLine(); }
});
</script>
</body>
</html>
