<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chubby Chunklet</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@600;700&display=swap" rel="stylesheet">
<style>
:root {
  --endpoint: https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet;

  /* Color / typography */
  --terminal-color:#1034a6; /* royal blue; change to #111 for black */
  --font-mono:'IBM Plex Mono',ui-monospace,Menlo,Consolas,monospace;

  /* Mouth positioning (tweak these quickly without hunting in markup) */
  --mouth-top:85px;
  --mouth-left:50%;
  --mouth-w:35px;
  --mouth-h:35px;

  /* Typing speed */
  --char-ms:20;

  /* Scales for stop‑motion mouth (closed → open) */
  --mouth-scale-0:0.18;
  --mouth-scale-1:0.45;
  --mouth-scale-2:0.75;
  --mouth-scale-3:1.05;
  --mouth-scale-4:1.35;
}

* { box-sizing:border-box; }
html,body {
  margin:0;
  padding:0;
  -webkit-font-smoothing:antialiased;
  font-family:Inter, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto;
  background:#fff;
  color:#111;
  height:100%;
}

body {
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  padding:32px 20px 40px;
}

.wrapper {
  flex:1;
  width:100%;
  max-width:1100px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:space-between;
  gap:40px;
}

.header {
  font-size:clamp(16px,2.2vw,22px);
  font-weight:600;
  letter-spacing:.4px;
  text-align:center;
  margin:0;
}

.header span { font-weight:700; }

.figure-zone {
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:54px;
  margin-top:8px;
}

.chunklet-wrap {
  position:relative;
  width:180px;
  height:230px;
  display:flex;
  align-items:flex-end;
  justify-content:center;
  pointer-events:none;
}

.chunklet-img {
  width:170px;
  max-width:100%;
  user-select:none;
  -webkit-user-drag:none;
  filter:drop-shadow(0 12px 32px rgba(0,0,0,.22));
  image-rendering:-webkit-optimize-contrast;
}

/* Mouth overlay */
.mouth-overlay {
  position:absolute;
  top:var(--mouth-top);
  left:var(--mouth-left);
  width:var(--mouth-w);
  height:var(--mouth-h);
  transform:translate(-50%,-50%);
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
}

.mouth-overlay svg {
  width:100%; height:100%;
}

#mouth {
  transform-origin:50% 50%;
  /* Start closed */
  transform:scaleY(var(--mouth-scale-0));
}

/* Retro button using PNG */
.trigger-button {
  position:relative;
  border:none;
  background:transparent;
  padding:0;
  cursor:pointer;
  outline:none;
  -webkit-tap-highlight-color:transparent;
  display:block;
}

.trigger-button img {
  width:118px;
  height:auto;
  display:block;
  transition:transform .12s cubic-bezier(.33,.9,.3,1), filter .15s;
  filter:drop-shadow(0 8px 22px rgba(0,0,0,.25)) drop-shadow(0 2px 4px rgba(0,0,0,.18));
}

.trigger-button:active img,
.trigger-button.pressed img {
  transform:translateY(7px) scale(.985);
  filter:drop-shadow(0 3px 9px rgba(0,0,0,.4)) brightness(.93) contrast(1.05);
}

.trigger-button:focus-visible img {
  outline:4px solid #5b8dff;
  outline-offset:4px;
}

/* Output / terminal line */
.output {
  font-family:var(--font-mono);
  font-size:clamp(10px,1.35vw,18px);
  line-height:1.45;
  letter-spacing:.5px;
  color:var(--terminal-color);
  max-width:820px;
  min-height:2.2em;
  text-align:left;
  margin:24px auto 0;
  white-space:pre-wrap;
  position:relative;
}

.cursor {
  display:inline-block;
  width:.6ch;
  background:var(--terminal-color);
  height:1em;
  vertical-align:baseline;
  animation:blink 1s steps(1,end) infinite;
  transform:translateY(2px);
}

.typing .cursor { animation:none; }

@keyframes blink {
  0%,55% {opacity:1;}
  56%,100% {opacity:0;}
}

.status {
  font:500 12px/1.3 var(--font-mono);
  opacity:.55;
  margin-top:12px;
  text-align:center;
}

.status.error { color:#c0392b; opacity:1; }

.footer-note {
  font:500 11px/1.35 var(--font-mono);
  opacity:.40;
  margin-top:22px;
  text-align:center;
  max-width:540px;
}

/* Mouth talking class (we drive discrete steps in JS; keyframes only as fallback idle) */
body.idle #mouth {
  animation:idleMouth 1.4s ease-in-out infinite;
}
@keyframes idleMouth {
  0%,100% { transform:scaleY(.22);}
  50% { transform:scaleY(.38);}
}

/* Small screens tighten spacing */
@media (max-height:740px) {
  .figure-zone { gap:38px; }
  .chunklet-wrap { height:200px; }
}
@media (max-width:320px){
  .chunklet-wrap { width:150px; height:200px; }
  .chunklet-img { width:140px; }
  :root {
    --mouth-top:70px;
    --mouth-w:36px;
    --mouth-h:36px;
  }
  .trigger-button img { width:102px; }
}

</style>
</head>
<body class="idle">
  <div class="wrapper">
    <h1 class="header">oh wow hey it's <span>chubby chunklet</span></h1>

    <div class="figure-zone">
      <div class="chunklet-wrap">
        <img src="littlemantalk.png" alt="Chubby Chunklet" class="chunklet-img" id="chunkletImg">
        <div class="mouth-overlay">
          <!-- Simple oval “mouth” -->
          <svg viewBox="0 0 100 100">
            <ellipse id="mouth" cx="50" cy="50" rx="26" ry="24" fill="#111"/>
          </svg>
        </div>
      </div>

      <button id="trigger" class="trigger-button" aria-label="Speak">
        <img id="keyImage" src="button.png" alt="Speak button">
        <!-- If you get a pressed image, store its path in data-pressed-src and swap in JS -->
        <!-- <img id="keyImage" src="button.png" data-pressed-src="button-pressed.png" alt="Speak button"> -->
      </button>
    </div>

    <div class="output" id="output"><span id="typed"></span><span id="cursor" class="cursor"></span></div>
    <div id="status" class="status"></div>
    <div class="footer-note">Press the key. Chunklet speaks. Retro typed output. Audio + mouth sync if available.</div>
  </div>

<script>
/* ================= CONFIG ================= */
const ENDPOINT = document.documentElement.style.getPropertyValue('--endpoint') || 
  'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';
const CHAR_MS = parseInt(getComputedStyle(document.documentElement)
                .getPropertyValue('--char-ms'),10) || 28;
const STOP_MOTION_FPS = 8;          // frames/sec for mouth quantization
const OPEN_STEPS = [
  parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--mouth-scale-0')),
  parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--mouth-scale-1')),
  parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--mouth-scale-2')),
  parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--mouth-scale-3')),
  parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--mouth-scale-4'))
];
/* ========================================== */

const trigger   = document.getElementById('trigger');
const keyImg    = document.getElementById('keyImage');
const typedSpan = document.getElementById('typed');
const cursor    = document.getElementById('cursor');
const statusEl  = document.getElementById('status');
const mouth     = document.getElementById('mouth');
let busy=false, typing=false;

let audioCtx, currentSource, timings=[], startTime=0, raf;
let lastText='';

function setStatus(msg, error=false){
  statusEl.textContent = msg || '';
  statusEl.classList.toggle('error', !!error);
}

function sanitize(text){
  text = (text||'').trim();
  if(!text) return 'A phantom noodle hummed your fortune.';
  text = text.replace(/!+$/,'').replace(/\s+/g,' ').trim();
  return /[.?!]$/.test(text) ? text : text + '.';
}

/* Typing effect */
function typeOut(text, done){
  typing=true;
  document.getElementById('output').classList.add('typing');
  typedSpan.textContent='';
  cursor.classList.remove('hidden');
  let i=0;
  function step(){
    const jitter = (i%7===0)? Math.random()*14 : 0;
    typedSpan.textContent = text.slice(0,i);
    i++;
    if(i<=text.length){
      setTimeout(step, CHAR_MS + jitter);
    }else{
      typing=false;
      document.getElementById('output').classList.remove('typing');
      if(done) done();
    }
  }
  step();
}

/* Audio + mouth */
function ensureCtx(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  }
  if(audioCtx.state === 'suspended') audioCtx.resume();
}

async function playAudio(b64){
  ensureCtx();
  const raw = atob(b64.replace(/^data:audio\/[a-zA-Z0-9.+-]+;base64,/, ''));
  const buf = new Uint8Array(raw.length); for(let i=0;i<raw.length;i++) buf[i]=raw.charCodeAt(i);
  const decoded = await audioCtx.decodeAudioData(buf.buffer);
  currentSource = audioCtx.createBufferSource();
  currentSource.buffer = decoded;
  currentSource.connect(audioCtx.destination);
  startTime = audioCtx.currentTime;
  startMouth();
  currentSource.start();
  currentSource.onended = () => stopMouth();
}

function stopAudio(){
  if(currentSource){
    try{ currentSource.stop(); }catch{}
    currentSource.disconnect();
    currentSource=null;
  }
}

/* Generate fake timings if backend omitted them */
function fabricateTimings(text){
  const total = Math.min(6, Math.max(2.3, text.length/18));
  const frames = Math.max(8, Math.min(40, Math.round(text.length/2.4)));
  const step = total / frames;
  timings = [];
  for(let i=0;i<=frames;i++){
    const open = (i%2)? 1 : Math.random()*0.25;
    timings.push({t:i*step, open});
  }
}

function quantize(open){
  // Convert raw 0..1 to discrete step 0..4
  const idx = Math.min(4, Math.max(0, Math.round(open * 4)));
  return OPEN_STEPS[idx];
}

function startMouth(){
  document.body.classList.remove('idle');
  cancelAnimationFrame(raf);
  animateMouth();
}

function stopMouth(){
  cancelAnimationFrame(raf);
  mouth.style.transform = `scaleY(${OPEN_STEPS[0]})`;
  document.body.classList.add('idle');
}

function animateMouth(){
  const t = audioCtx ? (audioCtx.currentTime - startTime) : performance.now()/1000;
  let open = 0.1;
  if(timings.length){
    for(let i=0;i<timings.length;i++){
      if(t >= timings[i].t) open = timings[i].open;
      else break;
    }
  } else {
    // fallback slow pulse
    open = (Math.sin(t*3)+1)/2;
  }
  const scale = quantize(open);
  mouth.style.transform = `scaleY(${scale})`;
  raf = requestAnimationFrame(animateMouth);
}

/* Summon */
async function summon(){
  if(busy) return;
  busy=true;
  trigger.classList.add('pressed');
  setStatus('Chunklet cogitates...');
  stopAudio(); stopMouth();
  typedSpan.textContent='';
  cursor.classList.remove('hidden');

  try{
    const res = await fetch(ENDPOINT);
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    let text = sanitize(data.text);
    lastText = text;
    timings = Array.isArray(data.timings) ? data.timings : [];
    typeOut(text, async ()=>{
      if(data.audioBase64){
        if(!timings.length) fabricateTimings(text);
        await playAudio(data.audioBase64);
      } else {
        fabricateTimings(text);
        startMouth();
        setTimeout(stopMouth, 3000);
      }
      setStatus('Ready.');
    });
  }catch(e){
    console.error(e);
    typeOut('A shy packet tripped. Try again.', ()=> setStatus('Temporary hiccup.', true));
  }finally{
    setTimeout(()=>trigger.classList.remove('pressed'), 160);
    busy=false;
  }
}

/* Events */
trigger.addEventListener('click', summon);
document.addEventListener('keydown', e=>{
  if(e.key===' '||e.key==='Enter'){
    summon();
    if(document.activeElement!==trigger) trigger.focus();
  }
});

/* Idle mouth gentle motion already via CSS */

/* Optional auto first line: uncomment if desired */
// summon();
</script>
</body>
</html>
