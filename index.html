<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>chubby chunklet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons -->
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="apple-touch-icon" href="favicon.png" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Emilys+Candy&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      /* Backend */
      --endpoint: https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet;

      /* Chunklet sprite / mouth (calibrated) */
      --figure-scale:1.15;
      --mouth-top:39%;
      --mouth-left:49%;
      --mouth-w:20px;
      --mouth-h:20px;
      --mouth-scale-0:.05;

      /* Typing */
      --char-ms:18;

      /* Door anchors (re-calibrated for the ivy-temple PNG) */
      --door-x: 0.492;   /* ⬅ anchor px / bg width  */
      --door-y: 0.582;   /* ⬆ anchor px / bg height */
      --door-w: 0.103;   /* width  (fraction of bg) */
      --door-h: 0.257;   /* height (fraction of bg) */

      /* Bubble layout */
      --output-top-fallback: 8vmin;
      --bubble-gap: 18px;
      --tail-x: 50%;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      font-family:Rubik, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:#000;color:#fff; -webkit-font-smoothing:antialiased;
      overflow:hidden; height:100%; width:100%;
    }

    .scene-container{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#4a7ba7; }
    .scene-bg{ width:100%; height:100%; position:relative; display:flex; align-items:center; justify-content:center; perspective:900px; }
    .scene-bg img{ width:100%; height:100%; object-fit:cover; display:block; user-select:none; -webkit-user-drag:none; }

    /* Door */
    .door-container{
      position:absolute; left:50%; top:52%; width:140px; height:180px;
      transform:translate(-50%, -50%); cursor:pointer; z-index:50;
    }
    .door-left, .door-right{
      position:absolute; width:50%; height:100%;
      background:#3d2418; border:3px solid #2d1810;
      transition:transform 0.8s cubic-bezier(0.68,-0.55,0.265,1.55);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.4), 0 0 10px rgba(0,0,0,0.8);
      backface-visibility:hidden; transform-style:preserve-3d;
    }
    .door-left{ left:0;  transform-origin:left center;  border-right:2px solid #1a0e08; }
    .door-right{right:0; transform-origin:right center; border-left: 2px solid #1a0e08; }
    .door-panel{ position:absolute; background:#2d1810; border:2px solid #1a0e08;
      box-shadow: inset 2px 2px 4px rgba(0,0,0,0.4), inset -1px -1px 2px rgba(61,36,24,0.3); }
    .door-left .panel-top{width:65%; height:22%; top:15%; left:17.5%}
    .door-left .panel-mid{width:65%; height:22%; top:41%; left:17.5%}
    .door-left .panel-bottom{width:65%; height:22%; top:67%; left:17.5%}
    .door-right .panel-top{width:65%; height:22%; top:15%; right:17.5%}
    .door-right .panel-mid{width:65%; height:22%; top:41%; right:17.5%}
    .door-right .panel-bottom{width:65%; height:22%; top:67%; right:17.5%}
    .door-open .door-left{ transform:rotateY(85deg); }
    .door-open .door-right{ transform:rotateY(-85deg); }

    /* Chunklet */
    .chunklet-container{
      position:absolute; transform:translate(-50%, -30px);
      opacity:0; transition:opacity 0.3s; z-index:60; pointer-events:none;
    }
    .chunklet-container.active{ opacity:1; }
    .chunklet-wrap{ position:relative; width:calc(100px*var(--figure-scale)); height:calc(130px*var(--figure-scale)); display:flex; align-items:flex-end; justify-content:center; }
    .chunklet-img{ width:calc(90px*var(--figure-scale)); filter:drop-shadow(0 8px 16px rgba(0,0,0,.6)); user-select:none; -webkit-user-drag:none; image-rendering:-webkit-optimize-contrast; }

    .ground-shadow{
      position:absolute; left:50%; bottom:-2px; width:88px; height:18px; transform:translateX(-50%) scale(0.6);
      background:radial-gradient(ellipse at center, rgba(0,0,0,.45) 0%, rgba(0,0,0,.25) 40%, rgba(0,0,0,0) 70%);
      filter:blur(2px); opacity:0; pointer-events:none;
    }

    /* Mouth overlay */
    .mouth-overlay{ position:absolute; top:var(--mouth-top); left:var(--mouth-left); width:var(--mouth-w); height:var(--mouth-h); transform:translate(-50%,-50%); pointer-events:none; }
    .mouth-overlay svg{width:100%;height:100%}
    #mouth{transform-origin:50% 50%; transform:scale(1, var(--mouth-scale-0))}

    /* ===== Speech bubble ===== */
    .output-container{
      position:fixed; left:50%; transform:translateX(-50%);
      width:80%; max-width:860px; min-width:260px;
      z-index:40; opacity:0; transition:opacity 0.35s;
      pointer-events:none; top:var(--output-top-fallback);
    }
    .output-container.active{ opacity:1; }

    .bubble-wrap{ position:relative; }
    .speech-bubble{
      background:#fff;
      border:6px solid #000;
      border-radius:38px;
      padding:26px 32px;
      color:#111;
      box-shadow:0 6px 0 #000, 0 14px 30px rgba(0,0,0,.35);
    }
    .bubble-tail{
      position:absolute; bottom:-2px; left:var(--tail-x);
      transform:translate(-50%, 100%); width:44px; height:28px; overflow:visible; pointer-events:none;
    }

    /* Quote text */
    .output{
      font-family:"Emilys Candy", Rubik, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      text-transform:uppercase; font-weight:400;
      font-size:clamp(22px, 2.4vw, 36px);
      line-height:1.07; letter-spacing:-0.06em; word-spacing:-0.04em;
      color:#111; text-align:center; margin:0; white-space:pre-wrap;
    }
    .cursor{
      display:inline-block; width:.55ch; height:1.05em; background:#111;
      vertical-align:text-bottom; animation:blink 1s steps(1,end) infinite; border-radius:2px;
    }
    @keyframes blink{0%,55%{opacity:1}56%,100%{opacity:0}}
    .typing .cursor{animation:none}

    .output .work-tag{
      opacity:.95; text-transform:uppercase; font-size:.64em; letter-spacing:-0.05em; word-spacing:-0.04em;
      color:#333; display:block; margin-top:10px; text-shadow:none;
    }

    /* Entrance / exit */
    @keyframes emergePop {0%{transform:translate(-50%,-60px) scale(.86,.92) rotate(-3deg);opacity:0;filter:brightness(.85)}40%{transform:translate(-50%,-28px) scale(1.06,.94) rotate(-2deg);opacity:1}60%{transform:translate(-50%,-18px) scale(.96,1.04) rotate(2deg)}100%{transform:translate(-50%,-12px) scale(1,1) rotate(0)}}
    @keyframes waddleDown {0%{transform:translate(-50%,-12px)}10%{transform:translate(-50%,0)}20%{transform:translate(-50%,10px)}30%{transform:translate(-50%,20px)}40%{transform:translate(-50%,30px)}55%{transform:translate(-50%,45px)}70%{transform:translate(-50%,58px)}85%{transform:translate(-50%,66px) scale(1.02,.98)}100%{transform:translate(-50%,70px)}}
    @keyframes shadowEmerge {0%{opacity:0;transform:translateX(-50%) scale(.4)}60%{opacity:.55;transform:translateX(-50%) scale(.75)}100%{opacity:.65;transform:translateX(-50%) scale(.85)}}
    @keyframes shadowWaddle {0%{opacity:.65;transform:translateX(-50%) scale(.85)}25%{opacity:.70;transform:translateX(-50%) scale(.95)}50%{opacity:.60;transform:translateX(-50%) scale(.88)}75%{opacity:.72;transform:translateX(-50%) scale(1.00)}100%{opacity:.68;transform:translateX(-50%) scale(1.05)}}
    .chunklet-container.emerge {animation:emergePop .7s cubic-bezier(.22,1,.36,1) forwards}
    .chunklet-container.waddle {animation:waddleDown 2.4s cubic-bezier(.22,1,.36,1) forwards}
    .chunklet-container.emerge .ground-shadow {animation:shadowEmerge .7s ease-out forwards}
    .chunklet-container.waddle .ground-shadow {animation:shadowWaddle 2.4s ease-out forwards}

    /* Calibration HUD (toggle with “C”) */
    .cal-hud{ position:fixed; left:8px; bottom:8px; font:12px/1.3 Rubik,ui-monospace,Menlo,Consolas,monospace; background:rgba(0,0,0,.6); color:#0ff;
      padding:8px 10px; border:1px solid rgba(0,255,255,.35); border-radius:6px; pointer-events:none; opacity:0; transition:opacity .15s; white-space:pre; z-index:100 }
    .cal-hud.on{ opacity:1 }

    @media(max-width:600px){
      .output-container{ width:92% }
      .output{ font-size:clamp(18px, 4.0vw, 28px) }
      .speech-bubble{ border-radius:30px; padding:22px 24px }
    }
  </style>
</head>
<body>
  <audio id="clickSnd" src="click.mp3" preload="auto"></audio>

  <div class="scene-container">
    <div class="scene-bg">
      <img src="skullbones.png" alt="Scene background" />

      <!-- Door -->
      <div class="door-container" id="doorTrigger" aria-label="Open the door" role="button" tabindex="0">
        <div class="door-left">
          <div class="door-panel panel-top"></div>
          <div class="door-panel panel-mid"></div>
          <div class="door-panel panel-bottom"></div>
        </div>
        <div class="door-right">
          <div class="door-panel panel-top"></div>
          <div class="door-panel panel-mid"></div>
          <div class="door-panel panel-bottom"></div>
        </div>
      </div>

      <!-- Chunklet -->
      <div class="chunklet-container" id="chunkletContainer" aria-hidden="true">
        <div class="chunklet-wrap">
          <img src="littleboytalk.png" alt="Chubby Chunklet" class="chunklet-img" />
          <div class="mouth-overlay">
            <svg viewBox="0 0 100 100" aria-hidden="true">
              <ellipse id="mouth" cx="50" cy="50" rx="26" ry="24" fill="#111"/>
            </svg>
          </div>
          <div class="ground-shadow"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Speech bubble output -->
  <div class="output-container" id="outputContainer" aria-live="polite">
    <div class="bubble-wrap">
      <div class="speech-bubble" id="bubble">
        <div class="output" id="output">
          <span id="typed"></span><span id="cursor" class="cursor"></span>
        </div>
      </div>
      <svg class="bubble-tail" id="bubbleTail" viewBox="0 0 44 28" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
        <path d="M4,2 C14,20 30,20 40,2" fill="#fff" stroke="#000" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <!-- Calibration HUD -->
  <div class="cal-hud" id="calHud"></div>

<script>
/* ===== CONFIG & Timings ===== */
const css = getComputedStyle(document.documentElement);
const ENDPOINT = (css.getPropertyValue('--endpoint') || '').trim() ||
  'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';
const QUERY    = '?style=canon&modern=0&accent=scottish';
const CHAR_MS  = parseInt(css.getPropertyValue('--char-ms'),10) || 20;

const DOOR_SWING_MS = 800, EMERGE_MS = 700, WADDLE_MS = 2400;
const BREATH_MS = 620;   /* inhale / exhale prep */

/* DOM */
const doorTrigger       = document.getElementById('doorTrigger');
const chunkletContainer = document.getElementById('chunkletContainer');
const outputContainer   = document.getElementById('outputContainer');
const typed             = document.getElementById('typed');
const cursor            = document.getElementById('cursor');
const mouth             = document.getElementById('mouth');
const clickSnd          = document.getElementById('clickSnd');
const bgImg             = document.querySelector('.scene-bg img');
const host              = document.querySelector('.scene-bg');

/* State */
let busy=false, doorOpen=false;
let audioCtx,currentSource,audioEl,mediaSource,analyser,timeData;
let raf,animating=false,tagPlaying=false,currentObjectURL=null;

/* ===== mouth anim setup (unchanged) ===== */
const SY=[0.07,0.55,1.10,1.70,2.30], SX=[1.00,1.01,1.02,1.02,1.03];
const THRESH_UP=[0.03,0.06,0.10,0.16], HYST_DELTA=0.018, THRESH_DOWN=THRESH_UP.map(t=>t-HYST_DELTA);
const GATE_FLOOR=0.010, CLOSE_GRACE_MS=20;
let level=0,lastChange=0;

function ensureCtx(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
function ensureAnalyser(){ ensureCtx(); if(!analyser){ analyser=audioCtx.createAnalyser(); analyser.fftSize=256; analyser.smoothingTimeConstant=0.0; timeData=new Float32Array(analyser.fftSize);} }
function attachAnalyserToBufferSource(src){ ensureAnalyser(); src.connect(analyser); analyser.connect(audioCtx.destination); }
function attachAnalyserToMediaElement(){
  ensureAnalyser();
  if(!audioEl){ audioEl=document.createElement('audio'); audioEl.hidden=true; document.body.appendChild(audioEl); }
  if(!mediaSource && audioCtx){ mediaSource=audioCtx.createMediaElementSource(audioEl); mediaSource.connect(analyser); analyser.connect(audioCtx.destination); }
}
function rmsLevel(){ if(!analyser) return 0; analyser.getFloatTimeDomainData(timeData); let s=0; for(const v of timeData) s+=v*v; const r=Math.sqrt(s/timeData.length); return r<GATE_FLOOR?0:r; }
function setLevel(n){ n=Math.max(0,Math.min(4,n|0)); if(n===level) return; level=n; mouth.style.transform=`scale(${SX[level]}, ${SY[level]})`; lastChange=performance.now(); }
function setClosed(){ setLevel(0); }
function startMouth(){ if(animating) return; animating=true; raf=requestAnimationFrame(tick); }
function stopMouth(){ animating=false; cancelAnimationFrame(raf); setClosed(); }
function tick(){
  if(!animating) return; raf=requestAnimationFrame(tick);
  const active=!!currentSource||tagPlaying, now=performance.now();
  if(active && analyser){
    const e=rmsLevel(); let target=level;
    while(target<4 && e>=THRESH_UP[target]) target++;
    while(target>0 && e<THRESH_DOWN[target-1]) target--;
    if(target<level && (now-lastChange)<CLOSE_GRACE_MS) target=level;
    setLevel(target); return;
  }
  /* idle wiggle */
  const phase=((now/1000*13)|0)%4, rand=Math.random();
  setLevel(phase===0?0:phase===1?(rand<.7?1:2):phase===2?(rand<.6?2:3):(rand<.5?3:4));
}

/* ===== Calibration helpers (door positioning) ===== */
const DOOR={
  get x(){ return parseFloat(css.getPropertyValue('--door-x'))||0.5; },
  get y(){ return parseFloat(css.getPropertyValue('--door-y'))||0.55; },
  get w(){ return parseFloat(css.getPropertyValue('--door-w'))||0.10; },
  get h(){ return parseFloat(css.getPropertyValue('--door-h'))||0.25; }
};
function positionDoorAndChunklet(){
  const hostRect=host.getBoundingClientRect(), natW=bgImg.naturalWidth, natH=bgImg.naturalHeight;
  const scale = Math.max(hostRect.width/natW, hostRect.height/natH);
  const dispW = natW*scale, dispH=natH*scale, offsetX=(hostRect.width-dispW)/2, offsetY=(hostRect.height-dispH)/2;
  const cx=offsetX+dispW*DOOR.x, cy=offsetY+dispH*DOOR.y, dw=dispW*DOOR.w, dh=dispH*DOOR.h;

  Object.assign(doorTrigger.style,{left:cx+'px',top:cy+'px',width:dw+'px',height:dh+'px',transform:'translate(-50%,-50%)'});
  Object.assign(chunkletContainer.style,{left:cx+'px',top:(cy+dh*0.35)+'px',transform:'translate(-50%,-30px)'});
  placeBubble();
}

/* ===== Bubble placement ===== */
function placeBubble(){
  const card=outputContainer.getBoundingClientRect(), guy=chunkletContainer.getBoundingClientRect();
  if(!(card.width&&guy.width)) return;
  const desiredBottom=Math.max(8,guy.top-parseFloat(css.getPropertyValue('--bubble-gap')));
  outputContainer.style.top=Math.max(8,desiredBottom-card.height)+'px';

  const tailPx=(guy.left+guy.width/2)-card.left;
  const tailPct=Math.max(8,Math.min(92,tailPx/card.width*100));
  outputContainer.style.setProperty('--tail-x',tailPct+'%');
}
new ResizeObserver(placeBubble).observe(outputContainer);

/* ===== Door choreography ===== */
function openDoor(){
  if(doorOpen) return;
  positionDoorAndChunklet();
  doorOpen=true; doorTrigger.classList.add('door-open');
  setTimeout(()=>{ chunkletContainer.classList.add('active','emerge');
    setTimeout(()=>{ chunkletContainer.classList.remove('emerge'); chunkletContainer.classList.add('waddle'); },EMERGE_MS);
  },DOOR_SWING_MS);
}
function closeDoor(){
  if(!doorOpen) return; doorOpen=false;
  chunkletContainer.classList.remove('active','waddle');
  doorTrigger.classList.remove('door-open');
}

/* ===== Typing helper ===== */
function typeOut(text,done){
  typed.textContent=''; cursor.style.display='inline-block';
  outputContainer.classList.add('typing');
  (function loop(i=0){
    typed.textContent=text.slice(0,i);
    placeBubble();
    if(i<text.length){ setTimeout(()=>loop(i+1),CHAR_MS+((i%7)?0:Math.random()*10)); }
    else{ outputContainer.classList.remove('typing'); cursor.style.display='none'; done&&done(); }
  })();
}

/* ===== Main summon ===== */
async function summon(){
  if(busy) return; busy=true; clickSnd.currentTime=0; clickSnd.play();

  /* Stage */
  openDoor();
  await new Promise(r=>setTimeout(r,DOOR_SWING_MS+EMERGE_MS+WADDLE_MS));
  /* Breath-prep */
  mouth.style.transition='transform 0.25s ease';
  mouth.style.transform='scale(1,2.4)';  /* inhale */
  await new Promise(r=>setTimeout(r,BREATH_MS/2));
  mouth.style.transform=`scale(${SX[0]},${SY[0]})`; /* exhale */
  await new Promise(r=>setTimeout(r,BREATH_MS/2));
  mouth.style.transition='';

  /* Fetch quote */
  try{
    const res=await fetch(ENDPOINT+QUERY,{cache:'no-store'});
    if(!res.ok) throw new Error(res.status);
    const data=await res.json(), text=(data.text||'').trim().replace(/!+$/,'');
    /* bubble appears now */
    outputContainer.classList.add('active');
    typeOut(/[\.\?!]$/.test(text)?text:text+'.',()=>{
      const showAttribution=()=>{ if(data.work||data.author){
        const span=document.createElement('span'); span.className='work-tag';
        span.textContent='— '+[data.work,data.author].filter(Boolean).join(' · ');
        document.getElementById('output').appendChild(span); placeBubble();
      }};
      if(data.audioBase64){
        playAudio(data.audioBase64,()=>{showAttribution(); setTimeout(closeDoor,2500); busy=false;});
      }else{
        showAttribution(); setTimeout(closeDoor,3000); busy=false;
      }
    });
  }catch(e){
    typeOut('A shy packet tripped. Try again.',()=>setTimeout(closeDoor,2000));
    busy=false;
  }
}

/* ===== Audio helpers ===== */
async function playAudio(b64,onEnd){
  try{
    ensureCtx(); ensureAnalyser();
    const bin=Uint8Array.from(atob(b64.split(',')[1]),c=>c.charCodeAt(0));
    const buf=await audioCtx.decodeAudioData(bin.buffer);
    currentSource=audioCtx.createBufferSource(); currentSource.buffer=buf; currentSource.playbackRate.value=1.08;
    attachAnalyserToBufferSource(currentSource);
    startMouth(); currentSource.start();
    currentSource.onended=()=>{ stopMouth(); currentSource=null; onEnd&&onEnd(); };
  }catch(e){ console.warn(e); onEnd&&onEnd(); }
}

/* ===== Boot ===== */
doorTrigger.addEventListener('click',summon);
doorTrigger.addEventListener('keydown',e=>{ if(e.key===' '||e.key==='Enter'){e.preventDefault();summon();}});
if(bgImg.complete) positionDoorAndChunklet(); else bgImg.addEventListener('load',positionDoorAndChunklet);
window.addEventListener('resize',positionDoorAndChunklet);
</script>
</body>
</html>
