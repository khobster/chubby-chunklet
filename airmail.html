<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>chubby chunklet ‚Äî airmail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="apple-touch-icon" href="favicon.png" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Emilys+Candy&family=Rubik:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --endpoint: https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet;

      /* mouth */
      --mouth-top:39%;
      --mouth-left:49%;
      --mouth-w:20px;
      --mouth-h:20px;
      --mouth-scale-0:.05;

      --char-ms:18;
      --tail-x:50%;
      --ivy-h:44vh;     /* ivy wall height */
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;height:100%;overflow:hidden;
      background:linear-gradient(#8cc8ff 0%, #bfe2ff 55%, #cfeaff 100%);
      font-family:Rubik, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:#111;
    }

    /* ===== Back button ===== */
    .mode-switch {
      position: fixed; top: 10px; left: 10px; z-index: 300;
      background:#fff; color:#111; border:3px solid #000; border-radius:12px;
      padding:10px 12px; text-decoration:none;
      display:flex; gap:8px; align-items:center;
      box-shadow:0 4px 0 #000, 0 10px 22px rgba(0,0,0,.25);
    }

    /* ===== Planes ===== */
    .sky{ position:absolute; inset:0; pointer-events:none; z-index:120; }
    .plane{
      position:absolute; top:12vh; width:66px; height:38px;
      pointer-events:auto; cursor:pointer;
      animation:driftLR var(--spd,18s) linear infinite;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.18));
    }
    /* LEFT -> RIGHT drift */
    @keyframes driftLR{
      from{ transform: translateX(-20vw) translateY(0) rotate(0deg); }
      to  { transform: translateX(110vw) translateY(0) rotate(0deg); }
    }
    .plane svg{ width:100%; height:100%; }
    .plane path{ fill:#fff; stroke:#111; stroke-width:4; stroke-linejoin:round; }
    .plane .accent{ stroke-width:3; }

    /* Falling clone */
    .falling{
      position:fixed; z-index:130; width:66px; height:38px; pointer-events:none;
      animation:fallspin 1.1s cubic-bezier(.22,1,.36,1) forwards;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }
    @keyframes fallspin{
      0%  { transform: translate(var(--sx,0px), var(--sy,0px)) rotate(0deg) scale(1); }
      68% { transform: translate(calc(var(--tx)*.9), calc(var(--ty)*.9)) rotate(360deg) scale(1); }
      100%{ transform: translate(var(--tx), var(--ty)) rotate(420deg) scale(.92); }
    }

    /* ===== Ivy wall ===== */
    .ivy{
      position:absolute; left:0; right:0; bottom:0; height:var(--ivy-h);
      z-index:150;
      /* Ivy-ish fake texture: layered radial-gradients */
      background:
        radial-gradient(circle at 20% 30%, #1d5b2a 0 18px, transparent 18px) 0 0/48px 48px,
        radial-gradient(circle at 70% 60%, #1f6b31 0 18px, transparent 18px) 24px 24px/48px 48px,
        linear-gradient(#1f662f, #1a5227);
      border-top:6px solid #0a2f15;
      box-shadow: inset 0 12px 18px rgba(0,0,0,.22);
    }

    /* Opening/sign */
    .placard{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: calc(var(--ivy-h) - 64px); /* sit embedded in ivy */
      width:120px; height:70px;
      background:#ffd028; border:6px solid #111; border-radius:6px;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 6px 0 #000, 0 14px 26px rgba(0,0,0,.35);
      z-index:170;
    }
    .placard span{
      font:700 36px/1 Rubik, system-ui; letter-spacing:1px;
      color:#3c2c00; text-shadow:0 2px 0 rgba(0,0,0,.2);
    }

    /* Lip that hides the reader‚Äôs body (sits above reader) */
    .ivy-lip{
      position:absolute; z-index:190;
      width:160px; height:28px; left:50%; transform:translateX(-50%);
      bottom: calc(var(--ivy-h) - 32px); /* right above placard */
      background:
        radial-gradient(circle at 25% 60%, #1e612e 0 12px, transparent 12px) 0 0/36px 36px,
        radial-gradient(circle at 70% 40%, #1a5227 0 12px, transparent 12px) 18px 18px/36px 36px,
        linear-gradient(#1c5a2b,#184b24);
      border-top:4px solid #0a2f15;
      box-shadow:0 -2px 6px rgba(0,0,0,.35), 0 6px 10px rgba(0,0,0,.35);
      border-radius:6px;
      pointer-events:none;
    }

    /* Reader head that pops up at opening */
    .reader{
      position:absolute; z-index:180;
      left:50%; transform:translateX(-50%) translateY(40px) scale(.94);
      bottom: calc(var(--ivy-h) - 12px);
      width:110px; height:150px; display:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45));
    }
    .reader.active{ display:block; animation:pop-up .35s cubic-bezier(.22,1,.36,1) forwards; }
    .reader.hide { animation:pop-down .35s cubic-bezier(.22,1,.36,1) forwards; }
    @keyframes pop-up   { from{ transform:translateX(-50%) translateY(40px) scale(.9); opacity:0; } to{ transform:translateX(-50%) translateY(-22px) scale(1); opacity:1; } }
    @keyframes pop-down { from{ transform:translateX(-50%) translateY(-22px) scale(1); opacity:1; } to{ transform:translateX(-50%) translateY(40px) scale(.9); opacity:0; } }

    .reader img{ width:100%; height:auto; user-select:none; -webkit-user-drag:none; }
    .mouth-overlay{ position:absolute; top:var(--mouth-top); left:var(--mouth-left); width:var(--mouth-w); height:var(--mouth-h); transform:translate(-50%,-50%); display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .mouth-overlay svg{width:100%;height:100%}
    #mouth{transform-origin:50% 50%; transform:scale(1, var(--mouth-scale-0))}

    /* ===== Bubble ===== */
    .output-container{
      position:fixed; left:50%; transform:translateX(-50%); top:8vmin;
      width:auto; max-width:90vw; text-align:center;
      z-index:250; opacity:0; transition:opacity .35s; pointer-events:none;
    }
    .output-container.active{ opacity:1; }
    .bubble-wrap{ position:relative; display:inline-block; }
    .speech-bubble{
      position:relative; background:#fff; color:#111;
      border:6px solid #000; border-radius:32px;
      padding:18px 26px 18px 22px;
      box-shadow:0 6px 0 #000, 0 14px 30px rgba(0,0,0,.35);
      display:inline-block; max-width:86vw;
    }
    .bubble-tail{
      position:absolute; bottom:-2px; left:var(--tail-x);
      transform:translate(-50%, 100%); width:44px; height:28px; overflow:visible;
    }
    .output{
      font-family:"Emilys Candy", Rubik, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      text-transform:uppercase; font-weight:400;
      font-size:clamp(22px, 2.4vw, 36px);
      line-height:1.04; letter-spacing:-0.06em; word-spacing:-0.04em;
      margin:0; white-space:pre-wrap; text-align:center;
    }
    .cursor{ display:inline-block; width:.5ch; height:1.05em; background:#111; vertical-align:text-bottom; animation:blink 1s steps(1,end) infinite; border-radius:2px; }
    @keyframes blink{0%,55%{opacity:1}56%,100%{opacity:0}}
    .typing .cursor{animation:none}
    .output .work-tag{ opacity:.95; text-transform:uppercase; margin-left:.6em; font-size:.62em; letter-spacing:-0.06em; word-spacing:-0.04em; color:#333; display:block; margin-top:10px; }

    @media (max-width:680px){
      .reader{ width:96px; height:132px; }
    }
  </style>
</head>
<body>
  <a class="mode-switch" href="index.html">üèõ Temple</a>

  <!-- planes -->
  <div class="sky" id="sky"></div>

  <!-- ivy wall + sign + lip -->
  <div class="ivy" id="ivy"></div>
  <div class="placard" id="placard"><span>43899</span></div>
  <div class="ivy-lip" id="ivyLip"></div>

  <!-- reader head -->
  <div class="reader" id="reader">
    <img src="littleboytalk.png" alt="Reader" />
    <div class="mouth-overlay">
      <svg viewBox="0 0 100 100" aria-hidden="true"><ellipse id="mouth" cx="50" cy="50" rx="26" ry="24" fill="#111"/></svg>
    </div>
  </div>

  <!-- bubble -->
  <div class="output-container" id="outputContainer" aria-live="polite">
    <div class="bubble-wrap">
      <div class="speech-bubble" id="bubble">
        <div class="output" id="output">
          <span id="typed"></span><span id="cursor" class="cursor"></span>
        </div>
      </div>
      <svg class="bubble-tail" id="bubbleTail" viewBox="0 0 44 28" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
        <path d="M4,2 C 14,20 30,20 40,2" fill="#fff" stroke="#000" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <audio id="clickSnd" src="click.mp3" preload="auto"></audio>

  <script>
    /* ===== Endpoint / basics ===== */
    const ENDPOINT = getComputedStyle(document.documentElement).getPropertyValue('--endpoint').trim()
      || 'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';
    const QUERY = '?style=canon&modern=0&accent=scottish';
    const CHAR_MS = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--char-ms'),10) || 18;

    const outputContainer = document.getElementById('outputContainer');
    const bubbleTail = document.getElementById('bubbleTail');
    const typed = document.getElementById('typed');
    const reader = document.getElementById('reader');
    const placard = document.getElementById('placard');
    const clickSnd = document.getElementById('clickSnd');
    const sky = document.getElementById('sky');

    /* ===== Planes ===== */
    function makePlane(delay=0, top='12vh', speed=16){
      const el = document.createElement('div');
      el.className = 'plane';
      el.style.top = top;
      el.style.setProperty('--spd', speed+'s');
      el.style.animationDelay = delay + 's';
      el.innerHTML = `
        <svg viewBox="0 0 66 38" aria-hidden="true">
          <path d="M8 20 L62 10 L40 34 L32 24 Z"/>
          <path class="accent" d="M34 18 L48 14"/>
        </svg>`;
      el.addEventListener('click', onPlaneClick);
      sky.appendChild(el);
    }
    makePlane(0.2, '10vh', 14);
    makePlane(3.8, '14vh', 17);
    makePlane(7.1, '8vh',  19);

    function onPlaneClick(e){
      try{ clickSnd.currentTime=0; clickSnd.play(); }catch(_){}
      const plane = e.currentTarget;
      const r = plane.getBoundingClientRect();
      const fall = plane.cloneNode(true);
      fall.classList.remove('plane'); fall.classList.add('falling');
      fall.style.left = r.left + 'px'; fall.style.top = r.top + 'px';
      fall.style.setProperty('--sx','0px'); fall.style.setProperty('--sy','0px');

      // target: placard center, just above its top edge
      const pr = placard.getBoundingClientRect();
      const tx = (pr.left + pr.width/2) - (r.left + r.width/2);
      const ty = (pr.top + pr.height*0.15) - (r.top + r.height/2);
      fall.style.setProperty('--tx', tx + 'px');
      fall.style.setProperty('--ty', ty + 'px');

      document.body.appendChild(fall);

      fall.addEventListener('animationend', ()=>{
        fall.remove();
        // wait a beat "behind the ivy", then pop reader + speak
        setTimeout(()=>popAndSpeak(), 220);
      }, {once:true});
    }

    /* ===== Bubble typing & placement ===== */
    function placeBubbleOver(xPx, yPx){
      const card = outputContainer.getBoundingClientRect();
      const gap = 18;
      const top = Math.max(8, Math.round(yPx - gap - card.height));
      outputContainer.style.top = top + 'px';

      const tailPx = xPx - card.left;
      const tailPct = Math.max(8, Math.min(92, tailPx / card.width * 100));
      outputContainer.style.setProperty('--tail-x', tailPct + '%');
    }
    function typeOut(text, done){
      typed.textContent='';
      document.getElementById('output').classList.add('typing');
      (function loop(i=0){
        typed.textContent = text.slice(0,i);
        if(i<text.length){
          setTimeout(()=>loop(i+1), CHAR_MS + ((i%7)?0:Math.random()*10));
        }else{
          document.getElementById('output').classList.remove('typing');
          done && done();
        }
      })();
    }
    function showWork(work, author){
      const old = document.querySelector('#output .work-tag'); if(old) old.remove();
      if(!work && !author) return;
      const span=document.createElement('span'); span.className='work-tag';
      span.textContent='‚Äî '+[work,author].filter(Boolean).join(' ¬∑ ');
      document.getElementById('output').appendChild(span);
    }

    /* ===== Audio mouth (same rig as temple) ===== */
    let audioCtx, analyser, timeData, currentSource, audioEl, mediaSource, tagPlaying=false, currentURL=null, iosInit=false;
    const isIOS = /iP(hone|od|ad)|Macintosh.*Mobile/.test(navigator.userAgent);
    function ensureCtx(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
    function ensureAnalyser(){ ensureCtx(); if(!analyser){ analyser=audioCtx.createAnalyser(); analyser.fftSize=256; analyser.smoothingTimeConstant=0; timeData=new Float32Array(analyser.fftSize);} }
    function attachAnalyserToBufferSource(src){ ensureAnalyser(); try{src.disconnect();}catch(_){ } src.connect(analyser); analyser.connect(audioCtx.destination); }
    function attachAnalyserToMediaElement(){
      ensureAnalyser();
      if(isIOS && !iosInit){ initializeIOSAudio(); return; }
      if(!audioEl){
        audioEl=document.createElement('audio');
        audioEl.style.position='absolute'; audioEl.style.left='-9999px';
        audioEl.setAttribute('playsinline',''); audioEl.setAttribute('webkit-playsinline','');
        document.body.appendChild(audioEl);
      }
      if(!mediaSource && audioCtx && audioEl){
        try{ mediaSource=audioCtx.createMediaElementSource(audioEl); mediaSource.connect(analyser); analyser.connect(audioCtx.destination); }
        catch(e){ console.warn('createMediaElementSource failed', e); }
      }
    }
    function initializeIOSAudio(){
      if(iosInit) return;
      try{
        ensureCtx();
        if(!audioEl){
          audioEl=document.createElement('audio');
          audioEl.style.position='absolute'; audioEl.style.left='-9999px';
          audioEl.setAttribute('playsinline',''); audioEl.setAttribute('webkit-playsinline',''); document.body.appendChild(audioEl);
        }
        const silent='data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u////////////////////////////////////////////////////////AAAAAExhdmY1OC40NS4xMDAAAAAAAAAAAAAAAAAAAAAkAAAAAAAAAAAAYYZn5GDeAAAAAAD/+1DEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u////////////////////////////////////////////////////////AAAAAExhdmY1OC40NS4xMDAAAAAAAAAAAAAAAAAAAAAkAAAAAAAAAAABhmfkYN4AAAAAAP/7UMQAA8AAAGkAAAAIAAANIAAAARMQU1AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
        audioEl.src=silent; audioEl.load();
        audioEl.play().then(()=>{ audioEl.pause(); audioEl.currentTime=0;
          if(!mediaSource && audioCtx){
            try{ mediaSource=audioCtx.createMediaElementSource(audioEl); ensureAnalyser(); mediaSource.connect(analyser); analyser.connect(audioCtx.destination); iosInit=true; }catch(e){}
          }
        }).catch(()=>{});
      }catch(_){}
    }
    const SY=[0.07,0.55,1.10,1.70,2.30], SX=[1.00,1.01,1.02,1.02,1.03];
    const TH_UP=[0.030,0.060,0.100,0.160], HDEL=0.018, TH_DN=TH_UP.map(t=>Math.max(0,t-HDEL));
    const FLOOR=0.010, CLOSE_MS=20; let level=0, lastChange=0, rafId=null, animOn=false;
    function setLevel(n){ n=Math.max(0,Math.min(4,n|0)); if(n===level) return; level=n; document.getElementById('mouth').style.transform=`scale(${SX[level]}, ${SY[level]})`; lastChange=performance.now(); }
    function rms(){ if(!analyser||!timeData) return 0; analyser.getFloatTimeDomainData(timeData); let s=0; for(let i=0;i<timeData.length;i++) s+=timeData[i]*timeData[i]; const r=Math.sqrt(s/timeData.length); return r<FLOOR?0:r; }
    function startMouth(){ if(animOn) return; animOn=true; rafId=requestAnimationFrame(tick); }
    function stopMouth(){ animOn=false; cancelAnimationFrame(rafId); setLevel(0); }
    function tick(){
      if(!animOn) return; rafId=requestAnimationFrame(tick);
      const active=!!currentSource||tagPlaying, now=performance.now();
      if(active && analyser){
        const e=rms(); let t=level;
        while(t<4 && e>=TH_UP[t]) t++;
        while(t>0 && e<TH_DN[t-1]) t--;
        if(t<level && (now-lastChange)<CLOSE_MS) t=level;
        setLevel(t);
      } else {
        const p=((now/1000*15)|0)%5; setLevel([1,2,3,2,1][p]);
      }
    }
    async function playAudio(b64,onEnd){
      if(isIOS){
        try{
          ensureCtx(); if(!iosInit){ initializeIOSAudio(); await new Promise(r=>setTimeout(r,100)); }
          attachAnalyserToMediaElement();
          const bin=Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
          const blob=new Blob([bin], {type:'audio/mp3'});
          if(currentURL){ URL.revokeObjectURL(currentURL); currentURL=null; }
          currentURL=URL.createObjectURL(blob);
          audioEl.src=currentURL; audioEl.load();
          audioEl.onplay = ()=>{ setLevel(0); startMouth(); tagPlaying=true; };
          audioEl.onended= ()=>{ tagPlaying=false; stopMouth(); if(currentURL){ URL.revokeObjectURL(currentURL); currentURL=null; } onEnd&&onEnd(); };
          const pp=audioEl.play(); if(pp!==undefined) await pp; return;
        }catch(e){ /* fall through */ }
      }
      try{
        ensureCtx(); ensureAnalyser();
        const bin=Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
        const buf=await audioCtx.decodeAudioData(bin.buffer);
        currentSource=audioCtx.createBufferSource(); currentSource.buffer=buf; currentSource.playbackRate.value=1.08;
        attachAnalyserToBufferSource(currentSource);
        setLevel(0); startMouth(); currentSource.start();
        currentSource.onended=()=>{ currentSource=null; stopMouth(); onEnd&&onEnd(); };
        return;
      }catch(e){
        startMouth(); setTimeout(()=>{ stopMouth(); onEnd&&onEnd(); }, 3000);
      }
    }

    /* ===== Sequence ===== */
    async function popAndSpeak(){
      // Position bubble tail over the opening
      const rr = reader.getBoundingClientRect();
      const pr = placard.getBoundingClientRect();

      // Pop the head
      reader.classList.remove('hide');
      reader.classList.add('active');

      // Fetch and speak
      try{
        const res = await fetch(ENDPOINT + QUERY, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        const textRaw = (data.text || '').trim().replace(/!+$/,'');
        const text = /[.?!]$/.test(textRaw) ? textRaw : textRaw + '.';

        // place bubble above the opening
        const x = pr.left + pr.width/2;
        const y = pr.top;
        outputContainer.classList.add('active');
        placeBubbleOver(x, y);

        typeOut(text, ()=>{ showWork(data.work||null, data.author||null); });

        if(data.audioBase64){
          await playAudio(data.audioBase64, ()=>{
            setTimeout(()=>{ reader.classList.add('hide'); outputContainer.classList.remove('active'); }, 500);
          });
        }else{
          // silent fallback
          const approx=Math.min(7, Math.max(2.2, text.length/16));
          setTimeout(()=>{ reader.classList.add('hide'); outputContainer.classList.remove('active'); }, (approx+0.4)*1000);
        }

      }catch(e){
        outputContainer.classList.add('active');
        typeOut('A shy packet tripped. Try again.', ()=>{
          setTimeout(()=>{ outputContainer.classList.remove('active'); }, 1000);
        });
        setTimeout(()=> reader.classList.add('hide'), 800);
      }
    }

    // Build reader at start so positioning is stable
    (function init(){
      // ensure reader is visually there (hidden) so bubble can aim later
      reader.style.display='block';
      reader.classList.add('hide'); // tucked under lip
      setTimeout(()=>reader.classList.remove('hide'), 10); // reset
      reader.style.display='none';
    })();

    // keyboard helper: Shift+T to temple
    window.addEventListener('keydown', e=>{ if(e.shiftKey && (e.key==='t'||e.key==='T')) location.href='index.html'; });
  </script>
</body>
</html>
