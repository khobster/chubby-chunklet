<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>chubby chunklet ‚Äî airmail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="apple-touch-icon" href="favicon.png" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Emilys+Candy&family=Rubik:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    :root{
      --endpoint: https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet;

      --ivy-h: 22vh;          /* lower wall so sky dominates */
      --mouth-top:39%;
      --mouth-left:49%;
      --mouth-w:20px;
      --mouth-h:20px;
      --mouth-scale-0:.05;
      --char-ms:18;
      --tail-x:50%;
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;height:100%;overflow:hidden;
      background:
        radial-gradient(1200px 600px at 50% -220px, rgba(255,255,255,.42), transparent 60%),
        linear-gradient(#86c2ff 0%, #a9d6ff 45%, #cfe8ff 100%);
      font-family:Rubik, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color:#111;
    }

    /* ===== Back button ===== */
    .mode-switch {
      position: fixed; top: 10px; left: 10px; z-index: 900;
      background:#fff; color:#111; border:3px solid #000; border-radius:12px;
      padding:10px 12px; text-decoration:none;
      display:flex; gap:8px; align-items:center;
      box-shadow:0 4px 0 #000, 0 10px 22px rgba(0,0,0,.25);
    }

    /* ===== SKY / PLANES ===== */
    .sky{ position:absolute; inset:0; z-index:120; }

    .plane{
      position:absolute; top:12vh; width:84px; height:48px; left:-18vw;
      cursor:pointer; pointer-events:auto;
      filter: drop-shadow(0 8px 14px rgba(0,0,0,.22));
      animation: driftLR var(--spd,18s) linear forwards;
      /* each plane wrapper animates translateX; inner SVG handles bob/tilt */
    }
    .plane.rl{ left:auto; right:-18vw; animation: driftRL var(--spd,18s) linear forwards; }

    /* bob/tilt only on the SVG so it doesn't overwrite drift */
    .plane svg{
      width:100%; height:100%; display:block;
      animation:
        bob var(--bobDur,4.8s) ease-in-out infinite,
        tilt 6s ease-in-out infinite;
      transform-origin: 60% 50%;
    }
    .plane.face-left svg{ transform: scaleX(-1); }

    @keyframes driftLR { from{ transform: translateX(0); } to{ transform: translateX(120vw); } }
    @keyframes driftRL { from{ transform: translateX(0); } to{ transform: translateX(-120vw); } }
    @keyframes bob { 0%,100%{ translate: 0 0; } 50%{ translate: 0 -10px; } }
    @keyframes tilt{ 0%,100%{ rotate: 0deg; } 50%{ rotate: -4deg; } }

    .plane .body{ fill:url(#paperShade); stroke:#111; stroke-width:3.5; stroke-linejoin:round; }
    .plane .crease{ stroke:#111; stroke-width:2.2; fill:none; stroke-linecap:round; opacity:.9; }
    .plane .edge{ stroke:#111; stroke-width:3; fill:none; stroke-linecap:round; }

    /* Falling clone */
    .falling{
      position:fixed; z-index:300; width:84px; height:48px; pointer-events:none;
      animation:fallspin 1.05s cubic-bezier(.22,1,.36,1) forwards;
      filter: drop-shadow(0 12px 22px rgba(0,0,0,.35));
    }
    @keyframes fallspin{
      0%  { transform: translate(var(--sx,0px), var(--sy,0px)) rotate(0deg) scale(1); }
      72% { transform: translate(calc(var(--tx)*.9), calc(var(--ty)*.9)) rotate(430deg) scale(1); }
      100%{ transform: translate(var(--tx), var(--ty)) rotate(480deg) scale(.94); opacity:.92; }
    }

    /* ===== IVY WALL ===== */
    .ivy{
      position:absolute; left:0; right:0; bottom:0; height:var(--ivy-h);
      z-index:150;
      background: url('ivy.jpg') center/cover no-repeat, linear-gradient(#1c5a2b, #184b24);
      border-top:6px solid rgba(0,0,0,.6);
      box-shadow: inset 0 18px 28px rgba(0,0,0,.35);
    }

    .opening{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom: calc(var(--ivy-h) - 40px);   /* sits a touch below the rim */
      width:150px; height:86px; z-index:180;
      background:#f6c41f;
      border:6px solid #111; border-radius:6px;
      box-shadow:0 8px 0 #000, 0 16px 26px rgba(0,0,0,.45), inset 0 -8px 0 rgba(0,0,0,.12);
      display:flex; align-items:center; justify-content:center;
    }
    .digits{
      font:900 42px/1 Rubik, system-ui;
      letter-spacing:2px;
      color:#c75f00;
      text-shadow: 0 0 1px #c75f00, 0 2px 0 #000, 0 4px 6px rgba(0,0,0,.35);
      transform:skewX(-6deg);
    }

    /* rim just ABOVE the sign (no overlap on numbers) */
    .ivy-lip{
      position:absolute; z-index:190; width:220px; height:28px;
      left:50%; transform:translateX(-50%);
      bottom: calc(var(--ivy-h) - 8px);  /* above sign by ~32px */
      background: url('ivy.jpg') center/cover no-repeat, linear-gradient(#1c5a2b,#184b24);
      border-top:5px solid rgba(0,0,0,.55);
      box-shadow:0 -2px 10px rgba(0,0,0,.45), 0 10px 14px rgba(0,0,0,.35);
      border-radius:8px;
      pointer-events:none;
    }

    /* ===== READER (head only) ===== */
    .reader{
      position:absolute; z-index:185; left:50%;
      transform:translateX(-50%) translateY(40px) scale(.96);
      bottom: calc(var(--ivy-h) - 6px);
      width:118px; height:160px; display:none;
      filter: drop-shadow(0 12px 24px rgba(0,0,0,.5));
    }
    .reader.active{ display:block; animation:pop-up .35s cubic-bezier(.22,1,.36,1) forwards; }
    .reader.hide { animation:pop-down .35s cubic-bezier(.22,1,.36,1) forwards; }
    @keyframes pop-up   { from{ transform:translateX(-50%) translateY(40px) scale(.9); opacity:0; } to{ transform:translateX(-50%) translateY(-26px) scale(1); opacity:1; } }
    @keyframes pop-down { from{ transform:translateX(-50%) translateY(-26px) scale(1); opacity:1; } to{ transform:translateX(-50%) translateY(40px) scale(.9); opacity:0; } }
    .reader img{ width:100%; height:auto; user-select:none; -webkit-user-drag:none; }
    .mouth-overlay{ position:absolute; top:var(--mouth-top); left:var(--mouth-left); width:var(--mouth-w); height:var(--mouth-h); transform:translate(-50%,-50%); display:flex; align-items:center; justify-content:center; pointer-events:none; }
    .mouth-overlay svg{width:100%;height:100%}
    #mouth{transform-origin:50% 50%; transform:scale(1, var(--mouth-scale-0))}

    /* ===== Bubble ===== */
    .output-container{
      position:fixed; left:50%; transform:translateX(-50%); top:7vmin;
      width:auto; max-width:90vw; text-align:center;
      z-index:400; opacity:0; transition:opacity .35s; pointer-events:none;
    }
    .output-container.active{ opacity:1; }
    .bubble-wrap{ position:relative; display:inline-block; }
    .speech-bubble{
      position:relative; background:#fff; color:#111;
      border:6px solid #000; border-radius:32px;
      padding:18px 26px 18px 22px;
      box-shadow:0 6px 0 #000, 0 14px 30px rgba(0,0,0,.35);
      display:inline-block; max-width:86vw;
    }
    .bubble-tail{
      position:absolute; bottom:-2px; left:var(--tail-x);
      transform:translate(-50%, 100%); width:44px; height:28px; overflow:visible;
    }
    .output{
      font-family:"Emilys Candy", Rubik, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      text-transform:uppercase; font-weight:400;
      font-size:clamp(22px, 2.4vw, 36px);
      line-height:1.04; letter-spacing:-0.06em; word-spacing:-0.04em;
      margin:0; white-space:pre-wrap; text-align:center;
    }
    .cursor{ display:inline-block; width:.5ch; height:1.05em; background:#111; vertical-align:text-bottom; animation:blink 1s steps(1,end) infinite; border-radius:2px; }
    @keyframes blink{0%,55%{opacity:1}56%,100%{opacity:0}}
    .typing .cursor{animation:none}
    .output .work-tag{ opacity:.95; text-transform:uppercase; margin-left:.6em; font-size:.62em; letter-spacing:-0.06em; word-spacing:-0.04em; color:#333; display:block; margin-top:10px; }

    @media (max-width:680px){
      .reader{ width:102px; height:140px; }
      .opening{ width:136px; height:78px; bottom: calc(var(--ivy-h) - 36px); }
      .ivy-lip{ bottom: calc(var(--ivy-h) - 6px); }
      .digits{ font-size:38px; }
    }
  </style>
</head>
<body>
  <a class="mode-switch" href="index.html">üèõ Temple</a>

  <!-- planes go here -->
  <div class="sky" id="sky"></div>

  <!-- ivy wall + opening + lip -->
  <div class="ivy" id="ivy"></div>
  <div class="opening" id="opening"><div class="digits">43899</div></div>
  <div class="ivy-lip" id="ivyLip"></div>

  <!-- reader head -->
  <div class="reader" id="reader">
    <img src="littleboytalk.png" alt="Reader" />
    <div class="mouth-overlay">
      <svg viewBox="0 0 100 100" aria-hidden="true"><ellipse id="mouth" cx="50" cy="50" rx="26" ry="24" fill="#111"/></svg>
    </div>
  </div>

  <!-- bubble -->
  <div class="output-container" id="outputContainer" aria-live="polite">
    <div class="bubble-wrap">
      <div class="speech-bubble" id="bubble">
        <div class="output" id="output">
          <span id="typed"></span><span id="cursor" class="cursor"></span>
        </div>
      </div>
      <svg class="bubble-tail" id="bubbleTail" viewBox="0 0 44 28" preserveAspectRatio="xMidYMid meet" aria-hidden="true">
        <path d="M4,2 C 14,20 30,20 40,2" fill="#fff" stroke="#000" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
  </div>

  <audio id="clickSnd" src="click.mp3" preload="auto"></audio>

  <!-- defs for paper shading -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="paperShade" x1="0" x2="1" y1="0" y2="1">
        <stop offset="0" stop-color="#ffffff"/>
        <stop offset=".65" stop-color="#f7f7f7"/>
        <stop offset="1" stop-color="#ececec"/>
      </linearGradient>
    </defs>
  </svg>

  <script>
    /* ===== Endpoint / basics ===== */
    const ENDPOINT = getComputedStyle(document.documentElement).getPropertyValue('--endpoint').trim()
      || 'https://pu30nzsu59.execute-api.us-east-1.amazonaws.com/dev/chunklet';
    const QUERY = '?style=canon&modern=0&accent=scottish';
    const CHAR_MS = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--char-ms'),10) || 18;

    const outputContainer = document.getElementById('outputContainer');
    const bubbleTail = document.getElementById('bubbleTail');
    const typed = document.getElementById('typed');
    const reader = document.getElementById('reader');
    const opening = document.getElementById('opening');
    const clickSnd = document.getElementById('clickSnd');
    const sky = document.getElementById('sky');

    /* ===== Nice plane SVG ===== */
    const PLANE_SVG = `
      <svg viewBox="0 0 84 48" aria-hidden="true">
        <path class="body" d="M6 24 L78 10 L52 40 L40 30 L30 36 L34 26 L6 24 Z"/>
        <path class="edge" d="M34 26 L72 14" />
        <path class="crease" d="M6 24 L40 30" />
        <path class="crease" d="M34 26 L44 34" />
      </svg>`;

    /* ===== Spawner: real drift across screen ===== */
    function spawnPlane(){
      const dirRL = Math.random() < 0.65; // mostly right->left
      const el = document.createElement('div');
      el.className = 'plane' + (dirRL ? ' rl' : '');
      el.innerHTML = PLANE_SVG;
      if(dirRL) el.classList.add('face-left');

      // random altitude & pace
      el.style.top = (8 + Math.random()*12) + 'vh';
      el.style.setProperty('--spd', (14 + Math.random()*7) + 's');
      el.style.setProperty('--bobDur', (4.4 + Math.random()*1.2) + 's');

      el.addEventListener('click', onPlaneClick, {once:true});
      sky.appendChild(el);

      // cleanup after it leaves
      const total = parseFloat(getComputedStyle(el).getPropertyValue('--spd'))*1000;
      setTimeout(()=> el.remove(), total + 200);
    }

    // start a few immediately, then keep spawning
    for(let i=0;i<3;i++) setTimeout(spawnPlane, i*800);
    setInterval(spawnPlane, 2600 + Math.random()*1600);

    function onPlaneClick(e){
      try{ clickSnd.currentTime=0; clickSnd.play(); }catch(_){}
      const plane = e.currentTarget;
      // snapshot position
      const r = plane.getBoundingClientRect();
      const fall = document.createElement('div');
      fall.className = 'falling';
      fall.style.left = r.left + 'px';
      fall.style.top  = r.top + 'px';
      fall.style.width = r.width + 'px';
      fall.style.height= r.height + 'px';
      fall.innerHTML = PLANE_SVG;
      if(plane.classList.contains('face-left')) fall.firstElementChild.style.transform='scaleX(-1)';

      // target: opening center, just above its top edge
      const pr = opening.getBoundingClientRect();
      const tx = (pr.left + pr.width/2) - (r.left + r.width/2);
      const ty = (pr.top + pr.height*0.15) - (r.top + r.height/2);
      fall.style.setProperty('--tx', tx + 'px');
      fall.style.setProperty('--ty', ty + 'px');

      document.body.appendChild(fall);
      fall.addEventListener('animationend', ()=>{
        fall.remove();
        setTimeout(()=>popAndSpeak(), 180);
      }, {once:true});
    }

    /* ===== Bubble placement/typing ===== */
    function placeBubbleOver(xPx, yPx){
      const card = outputContainer.getBoundingClientRect();
      const gap = 18;
      const top = Math.max(8, Math.round(yPx - gap - card.height));
      outputContainer.style.top = top + 'px';

      const tailPx = xPx - card.left;
      const tailPct = Math.max(8, Math.min(92, tailPx / card.width * 100));
      outputContainer.style.setProperty('--tail-x', tailPct + '%');
    }
    function typeOut(text, done){
      typed.textContent='';
      document.getElementById('output').classList.add('typing');
      (function loop(i=0){
        typed.textContent = text.slice(0,i);
        if(i<text.length){
          setTimeout(()=>loop(i+1), CHAR_MS + ((i%7)?0:Math.random()*10));
        }else{
          document.getElementById('output').classList.remove('typing');
          done && done();
        }
      })();
    }
    function showWork(work, author){
      const old = document.querySelector('#output .work-tag'); if(old) old.remove();
      if(!work && !author) return;
      const span=document.createElement('span'); span.className='work-tag';
      span.textContent='‚Äî '+[work,author].filter(Boolean).join(' ¬∑ ');
      document.getElementById('output').appendChild(span);
    }

    /* ===== Audio mouth rig (unchanged from temple) ===== */
    let audioCtx, analyser, timeData, currentSource, audioEl, mediaSource, tagPlaying=false, currentURL=null, iosInit=false;
    const isIOS = /iP(hone|od|ad)|Macintosh.*Mobile/.test(navigator.userAgent);
    function ensureCtx(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended') audioCtx.resume(); }
    function ensureAnalyser(){ ensureCtx(); if(!analyser){ analyser=audioCtx.createAnalyser(); analyser.fftSize=256; analyser.smoothingTimeConstant=0; timeData=new Float32Array(analyser.fftSize);} }
    function attachAnalyserToBufferSource(src){ ensureAnalyser(); try{src.disconnect();}catch(_){ } src.connect(analyser); analyser.connect(audioCtx.destination); }
    function attachAnalyserToMediaElement(){
      ensureAnalyser();
      if(isIOS && !iosInit){ initializeIOSAudio(); return; }
      if(!audioEl){
        audioEl=document.createElement('audio');
        audioEl.style.position='absolute'; audioEl.style.left='-9999px';
        audioEl.setAttribute('playsinline',''); audioEl.setAttribute('webkit-playsinline','');
        document.body.appendChild(audioEl);
      }
      if(!mediaSource && audioCtx && audioEl){
        try{ mediaSource=audioCtx.createMediaElementSource(audioEl); mediaSource.connect(analyser); analyser.connect(audioCtx.destination); }
        catch(e){ console.warn('createMediaElementSource failed', e); }
      }
    }
    function initializeIOSAudio(){
      if(iosInit) return;
      try{
        ensureCtx();
        if(!audioEl){
          audioEl=document.createElement('audio');
          audioEl.style.position='absolute'; audioEl.style.left='-9999px';
          audioEl.setAttribute('playsinline',''); audioEl.setAttribute('webkit-playsinline',''); document.body.appendChild(audioEl);
        }
        const silent='data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u////////////////////////////////////////////////////////AAAAAExhdmY1OC40NS4xMDAAAAAAAAAAAAAAAAAAAAAkAAAAAAAAAAAAYYZn5GDeAAAAAAD/+1DEAAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u////////////////////////////////////////////////////////AAAAAExhdmY1OC40NS4xMDAAAAAAAAAAAAAAAAAAAAAkAAAAAAAAAAABhmfkYN4AAAAAAP/7UMQAA8AAAGkAAAAIAAANIAAAARMQU1AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';
        audioEl.src=silent; audioEl.load();
        audioEl.play().then(()=>{ audioEl.pause(); audioEl.currentTime=0;
          if(!mediaSource && audioCtx){
            try{ mediaSource=audioCtx.createMediaElementSource(audioEl); ensureAnalyser(); mediaSource.connect(analyser); analyser.connect(audioCtx.destination); iosInit=true; }catch(e){}
          }
        }).catch(()=>{});
      }catch(_){}
    }
    const SY=[0.07,0.55,1.10,1.70,2.30], SX=[1.00,1.01,1.02,1.02,1.03];
    const TH_UP=[0.030,0.060,0.100,0.160], HDEL=0.018, TH_DN=TH_UP.map(t=>Math.max(0,t-HDEL));
    const FLOOR=0.010, CLOSE_MS=20; let level=0, lastChange=0, rafId=null, animOn=false;
    function setLevel(n){ n=Math.max(0,Math.min(4,n|0)); if(n===level) return; level=n; document.getElementById('mouth').style.transform=`scale(${SX[level]}, ${SY[level]})`; lastChange=performance.now(); }
    function startMouth(){ if(animOn) return; animOn=true; rafId=requestAnimationFrame(tick); }
    function stopMouth(){ animOn=false; cancelAnimationFrame(rafId); setLevel(0); }
    function rms(){ if(!analyser||!timeData) return 0; analyser.getFloatTimeDomainData(timeData); let s=0; for(let i=0;i<timeData.length;i++) s+=timeData[i]*timeData[i]; const r=Math.sqrt(s/timeData.length); return r<FLOOR?0:r; }
    function tick(){
      if(!animOn) return; rafId=requestAnimationFrame(tick);
      const active=!!currentSource||tagPlaying, now=performance.now();
      if(active && analyser){
        const e=rms(); let t=level;
        while(t<4 && e>=TH_UP[t]) t++;
        while(t>0 && e<TH_DN[t-1]) t--;
        if(t<level && (now-lastChange)<CLOSE_MS) t=level;
        setLevel(t);
      } else {
        const p=((now/1000*15)|0)%5; setLevel([1,2,3,2,1][p]);
      }
    }
    async function playAudio(b64,onEnd){
      if(isIOS){
        try{
          ensureCtx(); if(!iosInit){ initializeIOSAudio(); await new Promise(r=>setTimeout(r,100)); }
          attachAnalyserToMediaElement();
          const bin=Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
          const blob=new Blob([bin], {type:'audio/mp3'});
          if(currentURL){ URL.revokeObjectURL(currentURL); currentURL=null; }
          currentURL=URL.createObjectURL(blob);
          audioEl.src=currentURL; audioEl.load();
          audioEl.onplay = ()=>{ setLevel(0); startMouth(); tagPlaying=true; };
          audioEl.onended= ()=>{ tagPlaying=false; stopMouth(); if(currentURL){ URL.revokeObjectURL(currentURL); currentURL=null; } onEnd&&onEnd(); };
          const pp=audioEl.play(); if(pp!==undefined) await pp; return;
        }catch(e){ /* fall through */ }
      }
      try{
        ensureCtx(); ensureAnalyser();
        const bin=Uint8Array.from(atob(b64.split(',')[1]), c=>c.charCodeAt(0));
        const buf=await audioCtx.decodeAudioData(bin.buffer);
        currentSource=audioCtx.createBufferSource(); currentSource.buffer=buf; currentSource.playbackRate.value=1.08;
        try{ currentSource.disconnect(); }catch(_){}
        currentSource.connect(analyser); analyser.connect(audioCtx.destination);
        setLevel(0); startMouth(); currentSource.start();
        currentSource.onended=()=>{ currentSource=null; stopMouth(); onEnd&&onEnd(); };
        return;
      }catch(e){
        startMouth(); setTimeout(()=>{ stopMouth(); onEnd&&onEnd(); }, 3000);
      }
    }

    /* ===== Sequence ===== */
    function placeBubbleOverOpening(){
      const pr = opening.getBoundingClientRect();
      outputContainer.classList.add('active');
      const x = pr.left + pr.width/2;
      const y = pr.top;
      const card = outputContainer.getBoundingClientRect();
      const gap = 18;
      const top = Math.max(8, Math.round(y - gap - card.height));
      outputContainer.style.top = top + 'px';
      const tailPx = x - card.left;
      const tailPct = Math.max(8, Math.min(92, tailPx / card.width * 100));
      outputContainer.style.setProperty('--tail-x', tailPct + '%');
    }

    async function popAndSpeak(){
      reader.classList.remove('hide');
      reader.classList.add('active');

      try{
        const res = await fetch(ENDPOINT + QUERY, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        const textRaw = (data.text || '').trim().replace(/!+$/,'');
        const text = /[.?!]$/.test(textRaw) ? textRaw : textRaw + '.';

        placeBubbleOverOpening();
        typeOut(text, ()=>{ showWork(data.work||null, data.author||null); });

        if(data.audioBase64){
          await playAudio(data.audioBase64, ()=>{
            setTimeout(()=>{ reader.classList.add('hide'); outputContainer.classList.remove('active'); }, 500);
          });
        }else{
          const approx=Math.min(7, Math.max(2.2, text.length/16));
          setTimeout(()=>{ reader.classList.add('hide'); outputContainer.classList.remove('active'); }, (approx+0.4)*1000);
        }

      }catch(e){
        outputContainer.classList.add('active');
        typeOut('A shy packet tripped. Try again.', ()=>{
          setTimeout(()=>{ outputContainer.classList.remove('active'); }, 1000);
        });
        setTimeout(()=> reader.classList.add('hide'), 800);
      }
    }

    // little accessibility helper: Shift+T to temple
    window.addEventListener('keydown', e=>{ if(e.shiftKey && (e.key==='t'||e.key==='T')) location.href='index.html'; });
  </script>
</body>
</html>
